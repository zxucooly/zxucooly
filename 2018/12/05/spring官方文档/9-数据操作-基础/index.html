<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-z-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-z-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('https://zxucooly.github.io').hostname,
    root: '/',
    scheme: 'Mist',
    version: '7.6.0',
    exturl: true,
    sidebar: {"position":"right","display":"hide","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":true,"show_result":true,"style":"default"},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":true},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: true,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    comments: {"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":-1,"unescape":false,"preload":true},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>

  <meta name="description" content="1 事务管理1.1 理解事务管理的抽象类The key to the Spring transaction abstraction is the notion(概念) of a transaction strategy. A transaction strategy is defined by theorg.springframework.transaction.PlatformTransacti">
<meta property="og:type" content="article">
<meta property="og:title" content="9-数据操作-BASE">
<meta property="og:url" content="https://zxucooly.github.io/2018/12/05/spring%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3/9-%E6%95%B0%E6%8D%AE%E6%93%8D%E4%BD%9C-%E5%9F%BA%E7%A1%80/index.html">
<meta property="og:site_name" content="ZXUBLOG">
<meta property="og:description" content="1 事务管理1.1 理解事务管理的抽象类The key to the Spring transaction abstraction is the notion(概念) of a transaction strategy. A transaction strategy is defined by theorg.springframework.transaction.PlatformTransacti">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://docs.spring.io/spring/docs/5.0.8.RELEASE/spring-framework-reference/images/tx.png">
<meta property="og:image" content="https://docs.spring.io/spring/docs/5.0.8.RELEASE/spring-framework-reference/images/tx_prop_required.png">
<meta property="og:image" content="https://docs.spring.io/spring/docs/5.0.8.RELEASE/spring-framework-reference/images/tx_prop_requires_new.png">
<meta property="article:published_time" content="2018-12-05T08:45:00.000Z">
<meta property="article:modified_time" content="2019-12-23T15:00:52.086Z">
<meta property="article:author" content="zxucooly">
<meta property="article:tag" content="Spring官方文档">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://docs.spring.io/spring/docs/5.0.8.RELEASE/spring-framework-reference/images/tx.png">

<link rel="canonical" href="https://zxucooly.github.io/2018/12/05/spring%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3/9-%E6%95%B0%E6%8D%AE%E6%93%8D%E4%BD%9C-%E5%9F%BA%E7%A1%80/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true
  };
</script>

  <title>9-数据操作-BASE | ZXUBLOG</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">ZXUBLOG</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">PERSISTENCE</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签<span class="badge">18</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类<span class="badge">6</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档<span class="badge">48</span></a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="搜索..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://zxucooly.github.io/2018/12/05/spring%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3/9-%E6%95%B0%E6%8D%AE%E6%93%8D%E4%BD%9C-%E5%9F%BA%E7%A1%80/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="zxucooly">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZXUBLOG">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          9-数据操作-BASE
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-12-05 16:45:00" itemprop="dateCreated datePublished" datetime="2018-12-05T16:45:00+08:00">2018-12-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-12-23 23:00:52" itemprop="dateModified" datetime="2019-12-23T23:00:52+08:00">2019-12-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="1-事务管理"><a href="#1-事务管理" class="headerlink" title="1 事务管理"></a>1 事务管理</h1><h2 id="1-1-理解事务管理的抽象类"><a href="#1-1-理解事务管理的抽象类" class="headerlink" title="1.1 理解事务管理的抽象类"></a>1.1 理解事务管理的抽象类</h2><p>The key to the Spring transaction abstraction is the notion(<strong>概念</strong>) of a <em>transaction strategy</em>. A transaction strategy is defined by the<code>org.springframework.transaction.PlatformTransactionManager</code> interface:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PlatformTransactionManager</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">TransactionStatus <span class="title">getTransaction</span><span class="params">(TransactionDefinition definition)</span> </span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> TransactionException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">commit</span><span class="params">(TransactionStatus status)</span> <span class="keyword">throws</span> TransactionException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">rollback</span><span class="params">(TransactionStatus status)</span> <span class="keyword">throws</span> TransactionException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p>This is primarily a service provider interface (SPI), although it can be used <span class="exturl" data-url="aHR0cHM6Ly9kb2NzLnNwcmluZy5pby9zcHJpbmcvZG9jcy81LjAuOC5SRUxFQVNFL3NwcmluZy1mcmFtZXdvcmstcmVmZXJlbmNlL2RhdGEtYWNjZXNzLmh0bWwjdHJhbnNhY3Rpb24tcHJvZ3JhbW1hdGljLXB0bQ==" title="https://docs.spring.io/spring/docs/5.0.8.RELEASE/spring-framework-reference/data-access.html#transaction-programmatic-ptm">programmatically<i class="fa fa-external-link"></i></span> from your application code. </p>
<p>Because <code>PlatformTransactionManager</code> is an <em>interface</em>, it can be easily mocked or stubbed as necessary. It is not tied to a lookup strategy such as JNDI. </p>
<p><code>PlatformTransactionManager</code> implementations are defined like any other object (or bean) in the Spring Framework IoC container. </p>
<p>This benefit alone makes Spring Framework transactions a worthwhile abstraction even when you work with JTA. <strong>Transactional code can be tested much more easily than if it used JTA directly.</strong></p>
<p>Again in keeping with Spring’s philosophy, the <code>TransactionException</code> that can be thrown by any of the <code>PlatformTransactionManager</code> interface’s methods is <em>unchecked</em> (that is, it extends the <code>java.lang.RuntimeException</code> class). Transaction infrastructure failures are almost invariably fatal（总是致命的）. In rare cases where application code can actually recover from a transaction failure, the application developer can still choose to catch and handle <code>TransactionException</code>. The salient point is that developers are not <em>forced</em> to do so(重要的一点是，开发人员不必被迫这样做。).</p>
<p>The <code>getTransaction(..)</code> method returns a <code>TransactionStatus</code> object, depending on a <code>TransactionDefinition</code> parameter. The returned <code>TransactionStatus</code> might represent a new transaction, or can represent an existing transaction if a matching transaction exists in the current call stack. The implication in this latter case is that, as with Java EE transaction contexts, a <code>TransactionStatus</code> is associated with a <em>thread</em> of execution(后一种情况的含义是，与Java EE事务上下文一样，事务状态与执行线程关联-》<strong>已存在事务</strong>。).</p>
<p>The <code>TransactionDefinition</code> interface specifies:</p>
<ul>
<li><em>Propagation</em>: Typically, all code executed within a transaction scope will run in that transaction. However, you have the option of specifying the behavior in the event that a transactional method is executed when a transaction context already exists. For example, code can continue running in the existing transaction (the common case); or the existing transaction can be suspended and a new transaction created. <em>Spring offers all of the transaction propagation options familiar from EJB CMT</em>. To read about the semantics of transaction propagation in Spring, see <span class="exturl" data-url="aHR0cHM6Ly9kb2NzLnNwcmluZy5pby9zcHJpbmcvZG9jcy81LjAuOC5SRUxFQVNFL3NwcmluZy1mcmFtZXdvcmstcmVmZXJlbmNlL2RhdGEtYWNjZXNzLmh0bWwjdHgtcHJvcGFnYXRpb24=" title="https://docs.spring.io/spring/docs/5.0.8.RELEASE/spring-framework-reference/data-access.html#tx-propagation">Transaction propagation<i class="fa fa-external-link"></i></span>.</li>
<li><em>Isolation</em>: The degree to which this transaction is isolated from the work of other transactions. For example, can this transaction see uncommitted writes from other transactions?</li>
<li><em>Timeout</em>: How long this transaction runs before timing out and being rolled back automatically by the underlying transaction infrastructure.</li>
<li><em>Read-only status</em>: A read-only transaction can be used when your code reads but does not modify data. Read-only transactions can be a useful optimization in some cases, such as when you are using Hibernate.</li>
</ul>
<p>These settings reflect standard transactional concepts. If necessary, refer to resources that discuss transaction isolation levels and other core transaction concepts. <strong>Understanding these concepts</strong> is essential to using the Spring Framework or any transaction management solution.</p>
<p>The <code>TransactionStatus</code> interface provides a simple way for transactional code to control transaction execution and query transaction status. The concepts should be familiar, as they are common to all transaction APIs:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TransactionStatus</span> <span class="keyword">extends</span> <span class="title">SavepointManager</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isNewTransaction</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">hasSavepoint</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setRollbackOnly</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isRollbackOnly</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">flush</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isCompleted</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Regardless of whether you opt for declarative or programmatic transaction management in Spring, defining the correct <code>PlatformTransactionManager</code> implementation is absolutely essential. You typically define this implementation through dependency injection.</p>
<p><code>PlatformTransactionManager</code> implementations normally require knowledge of the environment in which they work: JDBC, JTA, Hibernate, and so on.</p>
<p> The following examples show how you can define a local <code>PlatformTransactionManager</code> implementation. (This example works with plain JDBC.)</p>
<p>You define a JDBC <code>DataSource</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"dataSource"</span> <span class="attr">class</span>=<span class="string">"org.apache.commons.dbcp.BasicDataSource"</span> <span class="attr">destroy-method</span>=<span class="string">"close"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driverClassName"</span> <span class="attr">value</span>=<span class="string">"$&#123;jdbc.driverClassName&#125;"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"$&#123;jdbc.url&#125;"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"$&#123;jdbc.username&#125;"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"$&#123;jdbc.password&#125;"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>The related <code>PlatformTransactionManager</code> bean definition will then have a reference to the <code>DataSource</code> definition. It will look like this:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"txManager"</span> <span class="attr">class</span>=<span class="string">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>JTA配置</strong></li>
</ul>
<p>If you use JTA in a Java EE container then you use a container <code>DataSource</code>, obtained through JNDI, in conjunction with Spring’s <code>JtaTransactionManager</code>. This is what the JTA and JNDI lookup version would look like:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:jee</span>=<span class="string">"http://www.springframework.org/schema/jee"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xsi:schemaLocation</span>=<span class="string">"</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/jee</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/jee/spring-jee.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">jee:jndi-lookup</span> <span class="attr">id</span>=<span class="string">"dataSource"</span> <span class="attr">jndi-name</span>=<span class="string">"jdbc/jpetstore"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"txManager"</span> <span class="attr">class</span>=<span class="string">"org.springframework.transaction.jta.JtaTransactionManager"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- other &lt;bean/&gt; definitions here --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>The <code>JtaTransactionManager</code> does not need to know about the <code>DataSource</code>, or any other specific resources, because it uses the container’s global transaction management infrastructure.</p>
<blockquote>
<p>If the <code>DataSource</code>, used by any non-JTA transaction manager, is looked up via JNDI and managed by a Java EE container, then it should be non-transactional because the Spring Framework, rather than the Java EE container, will manage the transactions.</p>
</blockquote>
<p>The <code>txManager</code> bean in this case is of the <code>HibernateTransactionManager</code> type. In the same way as the <code>DataSourceTransactionManager</code> needs a reference to the <code>DataSource</code>, the <code>HibernateTransactionManager</code> needs a reference to the <code>SessionFactory</code>.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"sessionFactory"</span> <span class="attr">class</span>=<span class="string">"org.springframework.orm.hibernate5.LocalSessionFactoryBean"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"mappingResources"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>org/springframework/samples/petclinic/hibernate/petclinic.hbm.xml<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"hibernateProperties"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span></span><br><span class="line">            hibernate.dialect=$&#123;hibernate.dialect&#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"txManager"</span> <span class="attr">class</span>=<span class="string">"org.springframework.orm.hibernate5.HibernateTransactionManager"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"sessionFactory"</span> <span class="attr">ref</span>=<span class="string">"sessionFactory"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>If you are using Hibernate and Java EE container-managed JTA transactions, then you should simply use the same <code>JtaTransactionManager</code> as in the previous JTA example for JDBC.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"txManager"</span> <span class="attr">class</span>=<span class="string">"org.springframework.transaction.jta.JtaTransactionManager"</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>如果您使用JTA，那么不管您使用什么数据访问技术(JDBC、Hibernate JPA或任何其他受支持的技术)，您的事务管理器定义看起来都是一样的。这是因为JTA事务是全局事务，可以征募任何事务资源。</p>
<p>在所有这些情况下，应用程序代码都不需要更改。您可以仅通过更改配置来更改事务的管理方式，即使更改意味着从本地事务转移到全局事务，或者反之亦然。</p>
<h2 id="1-2-声明式事务管理"><a href="#1-2-声明式事务管理" class="headerlink" title="1.2 声明式事务管理"></a>1.2 声明式事务管理</h2><p>Spring框架的声明性事务管理是通过Spring面向方面编程(AOP)实现的，不过，由于事务方面代码是随Spring框架发行版而来的，并且可能以样板的方式使用，因此通常不需要理解AOP概念才能有效地使用这段代码。</p>
<p>Spring框架的声明性事务管理类似于EJB CMT，因为您可以从单个方法级别指定事务行为(或缺少事务行为)。如果需要，可以在事务上下文中进行setRollbackOnly()调用。这两种事务管理的区别是:</p>
<ul>
<li>Unlike EJB CMT, which is tied to JTA, the Spring Framework’s declarative transaction management works in any environment. It can work with JTA transactions or local transactions using JDBC, JPA or Hibernate by simply adjusting the configuration files.</li>
<li>You can apply the Spring Framework declarative transaction management to any class, not merely special classes such as EJBs.</li>
<li>The Spring Framework offers declarative <a href="https://docs.spring.io/spring/docs/5.0.8.RELEASE/spring-framework-reference/data-access.html#transaction-declarative-rolling-back" target="_blank" rel="noopener"><em>rollback rules</em>, </a>a feature with no EJB equivalent. Both programmatic and declarative support for rollback rules is provided.</li>
<li>The Spring Framework enables you to customize transactional behavior, by using AOP. For example, you can insert custom behavior in the case of transaction rollback. You can also add arbitrary advice, along with the transactional advice. With EJB CMT, you cannot influence the container’s transaction management except with <code>setRollbackOnly()</code>.</li>
<li><strong>The Spring Framework does not support propagation of transaction contexts across remote calls</strong>, as do high-end application servers. If you need this feature, we recommend that you use EJB. However, consider carefully before using such a feature, because normally, one does not want transactions to span remote calls.</li>
</ul>
<p>回滚规则的概念非常重要:它们使您能够指定哪些异常(和Throwable)应该导致自动回滚。您可以在配置中声明地指定这个，而不是在Java代码中。因此，尽管您仍然可以在TransactionStatus对象上调用setRollbackOnly()来回滚当前事务，但通常您可以指定一个规则，MyApplicationException必须始终导致回滚。此选项的显著优点是业务对象不依赖于事务基础结构。例如，它们通常不需要导入Spring事务api或其他Spring api。</p>
<p>Although EJB container default behavior automatically rolls back the transaction on a <em>system exception</em> (usually a runtime exception), EJB CMT does not roll back the transaction automatically on an<em>application exception</em> (that is, a checked exception other than <code>java.rmi.RemoteException</code>). While the Spring default behavior for declarative transaction management follows EJB convention (roll back is automatic only on unchecked exceptions), it is often useful to customize this behavior.</p>
<h3 id="1-2-1-理解声明式事务管理实现"><a href="#1-2-1-理解声明式事务管理实现" class="headerlink" title="1.2.1 理解声明式事务管理实现"></a>1.2.1 理解声明式事务管理实现</h3><p>The most important concepts to grasp with regard to the Spring Framework’s declarative transaction support are that this support is enabled <a href="https://docs.spring.io/spring/docs/5.0.8.RELEASE/spring-framework-reference/core.html#aop-understanding-aop-proxies" target="_blank" rel="noopener"><em>via AOP proxies</em></a>, and that the transactional advice is driven by <em>metadata</em> (currently XML- or annotation-based). The combination of AOP with transactional metadata yields an AOP proxy that uses a <code>TransactionInterceptor</code> in conjunction with an appropriate <code>PlatformTransactionManager</code> implementation to drive transactions <em>around method invocations</em>.</p>
<p>Conceptually, calling a method on a transactional proxy looks like this…</p>
<p><img src="https://docs.spring.io/spring/docs/5.0.8.RELEASE/spring-framework-reference/images/tx.png" alt="tx"></p>
<h3 id="1-2-2-声明式事务管理实现实例"><a href="#1-2-2-声明式事务管理实现实例" class="headerlink" title="1.2.2 声明式事务管理实现实例"></a>1.2.2 声明式事务管理实现实例</h3><p>Consider the following interface, and its attendant（随从的） implementation. This example uses <code>Foo</code> and <code>Bar</code> classes as placeholders so that you can concentrate on the transaction usage without focusing on a particular domain model. </p>
<p>For the purposes of this example, the fact that the <code>DefaultFooService</code> class throws <code>UnsupportedOperationException</code> instances in the body of each implemented method is good; it allows you to see transactions created and then rolled back in response to the<code>UnsupportedOperationException</code> instance.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// the service interface that we want to make transactional</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> x.y.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">FooService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">Foo <span class="title">getFoo</span><span class="params">(String fooName)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Foo <span class="title">getFoo</span><span class="params">(String fooName, String barName)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">insertFoo</span><span class="params">(Foo foo)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">updateFoo</span><span class="params">(Foo foo)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// an implementation of the above interface</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> x.y.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultFooService</span> <span class="keyword">implements</span> <span class="title">FooService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Foo <span class="title">getFoo</span><span class="params">(String fooName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Foo <span class="title">getFoo</span><span class="params">(String fooName, String barName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertFoo</span><span class="params">(Foo foo)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateFoo</span><span class="params">(Foo foo)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Assume that the first two methods of the <code>FooService</code> interface, <code>getFoo(String)</code> and <code>getFoo(String, String)</code>, must execute in the context of a transaction with read-only semantics, and that the other methods, <code>insertFoo(Foo)</code> and <code>updateFoo(Foo)</code>, must execute in the context of a transaction with read-write semantics. The following configuration is explained in detail in the next few paragraphs.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- from the file 'context.xml' --&gt;</span></span><br><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:aop</span>=<span class="string">"http://www.springframework.org/schema/aop"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tx</span>=<span class="string">"http://www.springframework.org/schema/tx"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xsi:schemaLocation</span>=<span class="string">"</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/tx</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/tx/spring-tx.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/aop</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/aop/spring-aop.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- this is the service object that we want to make transactional --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"fooService"</span> <span class="attr">class</span>=<span class="string">"x.y.service.DefaultFooService"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- the transactional advice (what 'happens'; see the &lt;aop:advisor/&gt; bean below) --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tx:advice</span> <span class="attr">id</span>=<span class="string">"txAdvice"</span> <span class="attr">transaction-manager</span>=<span class="string">"txManager"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- the transactional semantics... --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tx:attributes</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- all methods starting with 'get' are read-only --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"get*"</span> <span class="attr">read-only</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- other methods use the default transaction settings (see below) --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"*"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tx:attributes</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tx:advice</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- ensure that the above transactional advice runs for any execution</span></span><br><span class="line"><span class="comment">        of an operation defined by the FooService interface --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">id</span>=<span class="string">"fooServiceOperation"</span> <span class="attr">expression</span>=<span class="string">"execution(* x.y.service.FooService.*(..))"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:advisor</span> <span class="attr">advice-ref</span>=<span class="string">"txAdvice"</span> <span class="attr">pointcut-ref</span>=<span class="string">"fooServiceOperation"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- don't forget the DataSource --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"dataSource"</span> <span class="attr">class</span>=<span class="string">"org.apache.commons.dbcp.BasicDataSource"</span> <span class="attr">destroy-method</span>=<span class="string">"close"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driverClassName"</span> <span class="attr">value</span>=<span class="string">"oracle.jdbc.driver.OracleDriver"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"jdbc:oracle:thin:@rj-t42:1521:elvis"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"scott"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"tiger"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- similarly, don't forget the PlatformTransactionManager --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"txManager"</span> <span class="attr">class</span>=<span class="string">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- other &lt;bean/&gt; definitions here --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Examine the preceding configuration. You want to make a service object, the <code>fooService</code> bean, transactional. The transaction semantics to apply are encapsulated in the <code>&lt;tx:advice/&gt;</code> definition. The <code>&lt;tx:advice/&gt;</code> definition reads as “<em>… all methods on starting with ‘get’ are to execute in the context of a read-only transaction, and all other methods are to execute with the default transaction semantics</em>“. The <code>transaction-manager</code> attribute of the <code>&lt;tx:advice/&gt;</code> tag is set to the name of the<code>PlatformTransactionManager</code> bean that is going to <em>drive</em> the transactions, in this case, the <code>txManager</code> bean.</p>
<ul>
<li>使用</li>
</ul>
<p>The above configuration will be used to create a transactional proxy around the object that is created from the <code>fooService</code> bean definition. The proxy will be configured with the transactional advice, so that when an appropriate method is invoked <em>on the proxy</em>, a transaction is started, suspended, marked as read-only, and so on, depending on the transaction configuration associated with that method. Consider the following program that test drives the above configuration:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Boot</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">final</span> String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ApplicationContext ctx = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">"context.xml"</span>, Boot<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        FooService fooService = (FooService) ctx.getBean(<span class="string">"fooService"</span>);</span><br><span class="line">        fooService.insertFoo (<span class="keyword">new</span> Foo());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The output from running the preceding program will resemble the following. (The Log4J output and the stack trace from the UnsupportedOperationException thrown by the insertFoo(..) method of the DefaultFooService class have been truncated for clarity.)</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- the Spring container is starting up... --&gt;</span></span><br><span class="line">[AspectJInvocationContextExposingAdvisorAutoProxyCreator] - Creating implicit proxy for bean 'fooService' with 0 common interceptors and 1 specific interceptors</span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- the DefaultFooService is actually proxied --&gt;</span></span><br><span class="line">[JdkDynamicAopProxy] - Creating JDK dynamic proxy for [x.y.service.DefaultFooService]</span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- ... the insertFoo(..) method is now being invoked on the proxy --&gt;</span></span><br><span class="line">[TransactionInterceptor] - Getting transaction for x.y.service.FooService.insertFoo</span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- the transactional advice kicks in here... --&gt;</span></span><br><span class="line">[DataSourceTransactionManager] - Creating new transaction with name [x.y.service.FooService.insertFoo]</span><br><span class="line">[DataSourceTransactionManager] - Acquired Connection [org.apache.commons.dbcp.PoolableConnection@a53de4] for JDBC transaction</span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- the insertFoo(..) method from DefaultFooService throws an exception... --&gt;</span></span><br><span class="line">[RuleBasedTransactionAttribute] - Applying rules to determine whether transaction should rollback on java.lang.UnsupportedOperationException</span><br><span class="line">[TransactionInterceptor] - Invoking rollback for transaction on x.y.service.FooService.insertFoo due to throwable [java.lang.UnsupportedOperationException]</span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- and the transaction is rolled back (by default, RuntimeException instances cause rollback) --&gt;</span></span><br><span class="line">[DataSourceTransactionManager] - Rolling back JDBC transaction on Connection [org.apache.commons.dbcp.PoolableConnection@a53de4]</span><br><span class="line">[DataSourceTransactionManager] - Releasing JDBC Connection after transaction</span><br><span class="line">[DataSourceUtils] - Returning JDBC Connection to DataSource</span><br><span class="line"></span><br><span class="line">Exception in thread "main" java.lang.UnsupportedOperationException at x.y.service.DefaultFooService.insertFoo(DefaultFooService.java:14)</span><br><span class="line"><span class="comment">&lt;!-- AOP infrastructure stack trace elements removed for clarity --&gt;</span></span><br><span class="line">at $Proxy0.insertFoo(Unknown Source)</span><br><span class="line">at Boot.main(Boot.java:11)</span><br></pre></td></tr></table></figure>

<h3 id="1-2-3-Rolling-back-a-declarative-transaction"><a href="#1-2-3-Rolling-back-a-declarative-transaction" class="headerlink" title="1.2.3 Rolling back a declarative transaction"></a>1.2.3 Rolling back a declarative transaction</h3><p>The previous section outlined the basics of how to specify transactional settings for classes, typically service layer classes, declaratively in your application. This section describes how you can control the rollback of transactions in a simple declarative fashion.</p>
<p>The recommended way to indicate to the Spring Framework’s transaction infrastructure that a transaction’s work is to be rolled back is to throw an <code>Exception</code> from code that is currently executing in the context of a transaction. The Spring Framework’s transaction infrastructure code will catch any unhandled <code>Exception</code> as it bubbles up the call stack, and make a determination whether to mark the transaction for rollback.</p>
<p>In its default configuration, the Spring Framework’s transaction infrastructure code <em>only</em> marks a transaction for rollback in the case of runtime, unchecked exceptions; that is, when the thrown exception is an instance or subclass of <code>RuntimeException</code>. (<code>Error</code>s will also - by default - result in a rollback). Checked exceptions that are thrown from a transactional method do <em>not</em>result in rollback in the default configuration.</p>
<p>You can configure exactly which <code>Exception</code> types mark a transaction for rollback, including checked exceptions. The following XML snippet demonstrates how you configure rollback for a checked, application-specific <code>Exception</code> type.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tx:advice</span> <span class="attr">id</span>=<span class="string">"txAdvice"</span> <span class="attr">transaction-manager</span>=<span class="string">"txManager"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tx:attributes</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"get*"</span> <span class="attr">read-only</span>=<span class="string">"true"</span> <span class="attr">rollback-for</span>=<span class="string">"NoProductInStockException"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"*"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tx:attributes</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tx:advice</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>You can also specify ‘no rollback rules’, if you do <em>not</em> want a transaction rolled back when an exception is thrown. The following example tells the Spring Framework’s transaction infrastructure to commit the attendant transaction even in the face of an unhandled <code>InstrumentNotFoundException</code>.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tx:advice</span> <span class="attr">id</span>=<span class="string">"txAdvice"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tx:attributes</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"updateStock"</span> <span class="attr">no-rollback-for</span>=<span class="string">"InstrumentNotFoundException"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"*"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tx:attributes</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tx:advice</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>When the Spring Framework’s transaction infrastructure catches an exception and it consults configured rollback rules to determine whether to mark the transaction for rollback, the <em>strongest</em> matching rule wins. So in the case of the following configuration, any exception other than an <code>InstrumentNotFoundException</code> results in a rollback of the attendant transaction.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tx:advice</span> <span class="attr">id</span>=<span class="string">"txAdvice"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tx:attributes</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"*"</span> <span class="attr">rollback-for</span>=<span class="string">"Throwable"</span> <span class="attr">no-rollback-for</span>=<span class="string">"InstrumentNotFoundException"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tx:attributes</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tx:advice</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>You can also indicate a required rollback <em>programmatically</em>. Although very simple, this process is quite invasive, and tightly couples your code to the Spring Framework’s transaction infrastructure:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">resolvePosition</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// some business logic...</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (NoProductInStockException ex) &#123;</span><br><span class="line">        <span class="comment">// trigger rollback programmatically</span></span><br><span class="line">        TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>强烈建议您尽可能使用声明性方法回滚。如果您确实需要的话，可以使用编程回滚，但是它的使用与实现干净的基于pojo的体系结构背道而驰。</p>
<h3 id="1-2-4-Configuring-different-transactional-semantics-for-different-beans"><a href="#1-2-4-Configuring-different-transactional-semantics-for-different-beans" class="headerlink" title="1.2.4 Configuring different transactional semantics for different beans"></a>1.2.4 Configuring different transactional semantics for different beans</h3><p>Consider the scenario where you have a number of service layer objects, and you want to apply a <em>totally different</em> transactional configuration to each of them. You do this by defining distinct <code>&lt;aop:advisor/&gt;</code> elements with differing <code>pointcut</code> and <code>advice-ref</code> attribute values.</p>
<p>As a point of comparison, first assume that all of your service layer classes are defined in a root <code>x.y.service</code> package. To make all beans that are instances of classes defined in that package (or in subpackages) and that have names ending in <code>Service</code> have the default transactional configuration, you would write the following:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:aop</span>=<span class="string">"http://www.springframework.org/schema/aop"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tx</span>=<span class="string">"http://www.springframework.org/schema/tx"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xsi:schemaLocation</span>=<span class="string">"</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/tx</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/tx/spring-tx.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/aop</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/aop/spring-aop.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">id</span>=<span class="string">"serviceOperation"</span></span></span><br><span class="line"><span class="tag">                <span class="attr">expression</span>=<span class="string">"execution(* x.y.service..*Service.*(..))"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:advisor</span> <span class="attr">pointcut-ref</span>=<span class="string">"serviceOperation"</span> <span class="attr">advice-ref</span>=<span class="string">"txAdvice"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- these two beans will be transactional... --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"fooService"</span> <span class="attr">class</span>=<span class="string">"x.y.service.DefaultFooService"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"barService"</span> <span class="attr">class</span>=<span class="string">"x.y.service.extras.SimpleBarService"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- ... and these two beans won't --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"anotherService"</span> <span class="attr">class</span>=<span class="string">"org.xyz.SomeService"</span>/&gt;</span> <span class="comment">&lt;!-- (not in the right package) --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"barManager"</span> <span class="attr">class</span>=<span class="string">"x.y.service.SimpleBarManager"</span>/&gt;</span> <span class="comment">&lt;!-- (doesn't end in 'Service') --&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">tx:advice</span> <span class="attr">id</span>=<span class="string">"txAdvice"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tx:attributes</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"get*"</span> <span class="attr">read-only</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"*"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tx:attributes</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tx:advice</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- other transaction infrastructure beans such as a PlatformTransactionManager omitted... --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>The following example shows how to configure two distinct beans with totally different transactional settings.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span>?&gt;</span><br><span class="line">&lt;beans xmlns=<span class="string">"http://www.springframework.org/schema/beans"</span></span><br><span class="line">    xmlns:xsi=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span><br><span class="line">    xmlns:aop=<span class="string">"http://www.springframework.org/schema/aop"</span></span><br><span class="line">    xmlns:tx=<span class="string">"http://www.springframework.org/schema/tx"</span></span><br><span class="line">    xsi:schemaLocation=<span class="string">"</span></span><br><span class="line"><span class="string">        http://www.springframework.org/schema/beans</span></span><br><span class="line"><span class="string">        http://www.springframework.org/schema/beans/spring-beans.xsd</span></span><br><span class="line"><span class="string">        http://www.springframework.org/schema/tx</span></span><br><span class="line"><span class="string">        http://www.springframework.org/schema/tx/spring-tx.xsd</span></span><br><span class="line"><span class="string">        http://www.springframework.org/schema/aop</span></span><br><span class="line"><span class="string">        http://www.springframework.org/schema/aop/spring-aop.xsd"</span>&gt;</span><br><span class="line"></span><br><span class="line">    &lt;aop:config&gt;</span><br><span class="line"></span><br><span class="line">        &lt;aop:pointcut id=<span class="string">"defaultServiceOperation"</span></span><br><span class="line">                expression=<span class="string">"execution(* x.y.service.*Service.*(..))"</span>/&gt;</span><br><span class="line"></span><br><span class="line">        &lt;aop:pointcut id=<span class="string">"noTxServiceOperation"</span></span><br><span class="line">                expression=<span class="string">"execution(* x.y.service.ddl.DefaultDdlManager.*(..))"</span>/&gt;</span><br><span class="line"></span><br><span class="line">        &lt;aop:advisor pointcut-ref=<span class="string">"defaultServiceOperation"</span> advice-ref=<span class="string">"defaultTxAdvice"</span>/&gt;</span><br><span class="line"></span><br><span class="line">        &lt;aop:advisor pointcut-ref=<span class="string">"noTxServiceOperation"</span> advice-ref=<span class="string">"noTxAdvice"</span>/&gt;</span><br><span class="line"></span><br><span class="line">    &lt;/aop:config&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- <span class="function"><span class="keyword">this</span> bean will be <span class="title">transactional</span> <span class="params">(see the <span class="string">'defaultServiceOperation'</span> pointcut)</span> --&gt;</span></span><br><span class="line"><span class="function">    &lt;bean id</span>=<span class="string">"fooService"</span> <span class="class"><span class="keyword">class</span></span>=<span class="string">"x.y.service.DefaultFooService"</span>/&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- <span class="keyword">this</span> bean will also be transactional, but with totally different transactional settings --&gt;</span><br><span class="line">    &lt;bean id=<span class="string">"anotherFooService"</span> <span class="class"><span class="keyword">class</span></span>=<span class="string">"x.y.service.ddl.DefaultDdlManager"</span>/&gt;</span><br><span class="line"></span><br><span class="line">    &lt;tx:advice id=<span class="string">"defaultTxAdvice"</span>&gt;</span><br><span class="line">        &lt;tx:attributes&gt;</span><br><span class="line">            &lt;tx:method name=<span class="string">"get*"</span> read-only=<span class="string">"true"</span>/&gt;</span><br><span class="line">            &lt;tx:method name=<span class="string">"*"</span>/&gt;</span><br><span class="line">        &lt;/tx:attributes&gt;</span><br><span class="line">    &lt;/tx:advice&gt;</span><br><span class="line"></span><br><span class="line">    &lt;tx:advice id=<span class="string">"noTxAdvice"</span>&gt;</span><br><span class="line">        &lt;tx:attributes&gt;</span><br><span class="line">            &lt;tx:method name=<span class="string">"*"</span> propagation=<span class="string">"NEVER"</span>/&gt;</span><br><span class="line">        &lt;/tx:attributes&gt;</span><br><span class="line">    &lt;/tx:advice&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- other transaction infrastructure beans such as a PlatformTransactionManager omitted... --&gt;</span><br><span class="line"></span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure>

<h3 id="1-2-5-tx-advice-settings"><a href="#1-2-5-tx-advice-settings" class="headerlink" title="1.2.5 tx:advice/ settings"></a>1.2.5 <span class="exturl" data-url="dHg6YWR2aWNlLw==" title="tx:advice/">tx:advice/<i class="fa fa-external-link"></i></span> settings</h3><p>This section summarizes the various transactional settings that can be specified using the <code>&lt;tx:advice/&gt;</code> tag. The default <code>&lt;tx:advice/&gt;</code> settings are:</p>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLnNwcmluZy5pby9zcHJpbmcvZG9jcy81LjAuOC5SRUxFQVNFL3NwcmluZy1mcmFtZXdvcmstcmVmZXJlbmNlL2RhdGEtYWNjZXNzLmh0bWwjdHgtcHJvcGFnYXRpb24=" title="https://docs.spring.io/spring/docs/5.0.8.RELEASE/spring-framework-reference/data-access.html#tx-propagation">Propagation setting<i class="fa fa-external-link"></i></span> is <code>REQUIRED.</code></li>
<li>Isolation level is <code>DEFAULT.</code></li>
<li>Transaction is read/write.</li>
<li>Transaction timeout defaults to the default timeout of the underlying transaction system, or none if timeouts are not supported.</li>
<li>Any <code>RuntimeException</code> triggers rollback, and any checked <code>Exception</code> does not.</li>
</ul>
<p>You can change these default settings; the various attributes of the <code>&lt;tx:method/&gt;</code> tags that are nested within <code>&lt;tx:advice/&gt;</code> and <code>&lt;tx:attributes/&gt;</code> tags are summarized below:</p>
<table>
<thead>
<tr>
<th>Attribute</th>
<th>Required?</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><code>name</code></td>
<td>Yes</td>
<td></td>
<td>Method name(s) with which the transaction attributes are to be associated. The wildcard (<em>) character can be used to associate the same transaction attribute settings with a number of methods; for example, `get</em><code>,</code>handle<em><code>,</code>on</em>Event`, and so forth.</td>
</tr>
<tr>
<td><code>propagation</code></td>
<td>No</td>
<td>REQUIRED</td>
<td>Transaction propagation behavior.</td>
</tr>
<tr>
<td><code>isolation</code></td>
<td>No</td>
<td>DEFAULT</td>
<td>Transaction isolation level. Only applicable to propagation REQUIRED or REQUIRES_NEW.</td>
</tr>
<tr>
<td><code>timeout</code></td>
<td>No</td>
<td>-1</td>
<td>Transaction timeout (seconds). Only applicable to propagation REQUIRED or REQUIRES_NEW.</td>
</tr>
<tr>
<td><code>read-only</code></td>
<td>No</td>
<td>false</td>
<td>Read/write vs. read-only transaction. Only applicable to REQUIRED or REQUIRES_NEW.</td>
</tr>
<tr>
<td><code>rollback-for</code></td>
<td>No</td>
<td></td>
<td><code>Exception(s)</code> that trigger rollback; comma-delimited. For example,<code>com.foo.MyBusinessException,ServletException.</code></td>
</tr>
<tr>
<td><code>no-rollback-for</code></td>
<td>No</td>
<td></td>
<td><code>Exception(s)</code> that do <em>not</em> trigger rollback; comma-delimited. For example,<code>com.foo.MyBusinessException,ServletException.</code></td>
</tr>
</tbody></table>
<h3 id="1-2-6-Using-Transactional-注解方式"><a href="#1-2-6-Using-Transactional-注解方式" class="headerlink" title="1.2.6 Using @Transactional-注解方式"></a>1.2.6 Using @Transactional-注解方式</h3><p>In addition to the XML-based declarative approach to transaction configuration, you can use an annotation-based approach. Declaring transaction semantics directly in the Java source code puts the declarations much closer to the affected code. There is not much danger of undue coupling, because code that is meant to be used transactionally is almost always deployed that way anyway.</p>
<p>The ease-of-use afforded by the use of the <code>@Transactional</code> annotation is best illustrated with an example, which is explained in the text that follows. Consider the following class definition:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// the service class that we want to make transactional</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultFooService</span> <span class="keyword">implements</span> <span class="title">FooService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">Foo <span class="title">getFoo</span><span class="params">(String fooName)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Foo <span class="title">getFoo</span><span class="params">(String fooName, String barName)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">insertFoo</span><span class="params">(Foo foo)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">updateFoo</span><span class="params">(Foo foo)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>When the above POJO is defined as a bean in a Spring IoC container, the bean instance can be made transactional by adding merely <em>one</em> line of XML configuration:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- from the file 'context.xml' --&gt;</span></span><br><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:aop</span>=<span class="string">"http://www.springframework.org/schema/aop"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tx</span>=<span class="string">"http://www.springframework.org/schema/tx"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xsi:schemaLocation</span>=<span class="string">"</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/tx</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/tx/spring-tx.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/aop</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/aop/spring-aop.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- this is the service object that we want to make transactional --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"fooService"</span> <span class="attr">class</span>=<span class="string">"x.y.service.DefaultFooService"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- enable the configuration of transactional behavior based on annotations --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tx:annotation-driven</span> <span class="attr">transaction-manager</span>=<span class="string">"txManager"</span>/&gt;</span><span class="comment">&lt;!-- a PlatformTransactionManager is still required --&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"txManager"</span> <span class="attr">class</span>=<span class="string">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- (this dependency is defined somewhere else) --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- other &lt;bean/&gt; definitions here --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>The <code>@EnableTransactionManagement</code> annotation provides equivalent support if you are using Java based configuration. Simply add the annotation to a <code>@Configuration</code> class.</strong> </p>
<p>可以将@Transactional注释放在接口定义、接口上的方法、类定义或类上的公共方法之前。然而，仅存在@Transactional注释不足以激活事务行为。@Transactional注释只是元数据，可以由一些支持@Transactional的运行时基础结构使用，可以使用元数据配置具有事务行为的适当bean。在前面的示例中，元素切换到事务行为。</p>
<ul>
<li><strong>仅仅扫描到@Transaction注解的类并加入到同一个容器中</strong></li>
</ul>
<p><code>@EnableTransactionManagement</code> and <code>&lt;tx:annotation-driven/&gt;</code> only looks for <code>@Transactional</code> on beans in the same application context they are defined in. This means that, if you put annotation driven configuration in a <code>WebApplicationContext</code> for a <code>DispatcherServlet</code>, it only checks for <code>@Transactional</code> beans in your controllers, and not your services. </p>
<p>The most derived location takes precedence when evaluating the transactional settings for a method. In the case of the following example, the <code>DefaultFooService</code> class is annotated at the class level with the settings for a read-only transaction, but the <code>@Transactional</code> annotation on the <code>updateFoo(Foo)</code> method in the same class takes precedence over the transactional settings defined at the class level.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span>(readOnly = <span class="keyword">true</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultFooService</span> <span class="keyword">implements</span> <span class="title">FooService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Foo <span class="title">getFoo</span><span class="params">(String fooName)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// do something</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// these settings have precedence for this method 优先</span></span><br><span class="line">    <span class="meta">@Transactional</span>(readOnly = <span class="keyword">false</span>, propagation = Propagation.REQUIRES_NEW)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateFoo</span><span class="params">(Foo foo)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// do something</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="1-2-6-1-Transactional-settings"><a href="#1-2-6-1-Transactional-settings" class="headerlink" title="1.2.6.1 @Transactional settings"></a>1.2.6.1 @Transactional settings</h4><p>The <code>@Transactional</code> annotation is metadata that specifies that an interface, class, or method must have transactional semantics; for example, “<em>start a brand new read-only transaction when this method is invoked, suspending any existing transaction</em>“. The default <code>@Transactional</code> settings are as follows:</p>
<ul>
<li>Propagation setting is <code>PROPAGATION_REQUIRED.</code></li>
<li>Isolation level is <code>ISOLATION_DEFAULT.</code></li>
<li>Transaction is read/write.</li>
<li>Transaction timeout defaults to the default timeout of the underlying transaction system, or to none if timeouts are not supported.</li>
<li>Any <code>RuntimeException</code> triggers rollback, and any checked <code>Exception</code> does not.</li>
</ul>
<p>These default settings can be changed; the various properties of the <code>@Transactional</code> annotation are summarized in the following table:</p>
<table>
<thead>
<tr>
<th>Property</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLnNwcmluZy5pby9zcHJpbmcvZG9jcy81LjAuOC5SRUxFQVNFL3NwcmluZy1mcmFtZXdvcmstcmVmZXJlbmNlL2RhdGEtYWNjZXNzLmh0bWwjdHgtbXVsdGlwbGUtdHgtbWdycy13aXRoLWF0dHJhbnNhY3Rpb25hbA==" title="https://docs.spring.io/spring/docs/5.0.8.RELEASE/spring-framework-reference/data-access.html#tx-multiple-tx-mgrs-with-attransactional">value<i class="fa fa-external-link"></i></span></td>
<td>String</td>
<td>Optional qualifier specifying the transaction manager to be used.</td>
</tr>
<tr>
<td><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLnNwcmluZy5pby9zcHJpbmcvZG9jcy81LjAuOC5SRUxFQVNFL3NwcmluZy1mcmFtZXdvcmstcmVmZXJlbmNlL2RhdGEtYWNjZXNzLmh0bWwjdHgtcHJvcGFnYXRpb24=" title="https://docs.spring.io/spring/docs/5.0.8.RELEASE/spring-framework-reference/data-access.html#tx-propagation">propagation<i class="fa fa-external-link"></i></span></td>
<td>enum: <code>Propagation</code></td>
<td>Optional propagation setting.</td>
</tr>
<tr>
<td><code>isolation</code></td>
<td>enum: <code>Isolation</code></td>
<td>Optional isolation level. Only applicable to propagation REQUIRED or REQUIRES_NEW.</td>
</tr>
<tr>
<td><code>timeout</code></td>
<td>int (in seconds granularity)</td>
<td>Optional transaction timeout. Only applicable to propagation REQUIRED or REQUIRES_NEW.</td>
</tr>
<tr>
<td><code>readOnly</code></td>
<td>boolean</td>
<td>Read/write vs. read-only transaction. Only applicable to REQUIRED or REQUIRES_NEW.</td>
</tr>
<tr>
<td><code>rollbackFor</code></td>
<td>Array of <code>Class</code> objects, which must be derived from <code>Throwable.</code></td>
<td>Optional array of exception classes that <em>must</em> cause rollback.</td>
</tr>
<tr>
<td><code>rollbackForClassName</code></td>
<td>Array of class names. Classes must be derived from <code>Throwable.</code></td>
<td>Optional array of names of exception classes that <em>must</em> cause rollback.</td>
</tr>
<tr>
<td><code>noRollbackFor</code></td>
<td>Array of <code>Class</code> objects, which must be derived from <code>Throwable.</code></td>
<td>Optional array of exception classes that <em>must not</em> cause rollback.</td>
</tr>
<tr>
<td><code>noRollbackForClassName</code></td>
<td>Array of <code>String</code> class names, which must be derived from <code>Throwable.</code></td>
<td>Optional array of names of exception classes that <em>must not</em> cause rollback.</td>
</tr>
</tbody></table>
<p>Currently you cannot have explicit control over the name of a transaction, where ‘name’ means the transaction name that will be shown in a transaction monitor, if applicable (for example, WebLogic’s transaction monitor), and in logging output. For declarative transactions, the transaction name is always the fully-qualified class name + “.” + method name of the transactionally-advised class. For example, if the <code>handlePayment(..)</code> method of the <code>BusinessService</code> class started a transaction, the name of the transaction would be: <code>com.foo.BusinessService.handlePayment</code>.</p>
<h4 id="1-2-6-2-Multiple-Transaction-Managers-with-Transactional"><a href="#1-2-6-2-Multiple-Transaction-Managers-with-Transactional" class="headerlink" title="1.2.6.2 Multiple Transaction Managers with @Transactional"></a>1.2.6.2 Multiple Transaction Managers with @Transactional</h4><p>Most Spring applications only need a single transaction manager, but there may be situations where you want multiple independent transaction managers in a single application. The value attribute of the <code>@Transactional</code> annotation can be used to optionally specify the identity of the <code>PlatformTransactionManager</code> to be used. This can either be the bean name or the qualifier value of the transaction manager bean. For example, using the qualifier notation, the following Java code</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransactionalService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional</span>(<span class="string">"order"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSomething</span><span class="params">(String name)</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional</span>(<span class="string">"account"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doSomething</span><span class="params">()</span> </span>&#123; ... &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>could be combined with the following transaction manager bean declarations in the application context.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tx:annotation-driven</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"transactionManager1"</span> <span class="attr">class</span>=<span class="string">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span>&gt;</span></span><br><span class="line">        ...</span><br><span class="line">        <span class="tag">&lt;<span class="name">qualifier</span> <span class="attr">value</span>=<span class="string">"order"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"transactionManager2"</span> <span class="attr">class</span>=<span class="string">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span>&gt;</span></span><br><span class="line">        ...</span><br><span class="line">        <span class="tag">&lt;<span class="name">qualifier</span> <span class="attr">value</span>=<span class="string">"account"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>In this case, the two methods on <code>TransactionalService</code> will run under separate transaction managers, differentiated by the “order” and “account” qualifiers. The default <code>&lt;tx:annotation-driven&gt;</code> target bean name <code>transactionManager</code> will still be used if no specifically qualified PlatformTransactionManager bean is found.</p>
<h4 id="1-2-6-3-Custom-shortcut-annotations"><a href="#1-2-6-3-Custom-shortcut-annotations" class="headerlink" title="1.2.6.3 Custom shortcut annotations"></a>1.2.6.3 Custom shortcut annotations</h4><p>If you find you are repeatedly using the same attributes with <code>@Transactional</code> on many different methods, then <span class="exturl" data-url="aHR0cHM6Ly9kb2NzLnNwcmluZy5pby9zcHJpbmcvZG9jcy81LjAuOC5SRUxFQVNFL3NwcmluZy1mcmFtZXdvcmstcmVmZXJlbmNlL2NvcmUuaHRtbCNiZWFucy1tZXRhLWFubm90YXRpb25z" title="https://docs.spring.io/spring/docs/5.0.8.RELEASE/spring-framework-reference/core.html#beans-meta-annotations">Spring’s meta-annotation support<i class="fa fa-external-link"></i></span> allows you to define custom shortcut annotations for your specific use cases. For example, defining the following annotations</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(&#123;ElementType.METHOD, ElementType.TYPE&#125;)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Transactional</span>(<span class="string">"order"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> OrderTx &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Target</span>(&#123;ElementType.METHOD, ElementType.TYPE&#125;)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Transactional</span>(<span class="string">"account"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> AccountTx &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>allows us to write the example from the previous section as</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransactionalService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OrderTx</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSomething</span><span class="params">(String name)</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AccountTx</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doSomething</span><span class="params">()</span> </span>&#123; ... &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Here we have used the syntax to define the transaction manager qualifier, but could also have included propagation behavior, rollback rules, timeouts etc.</p>
<h3 id="1-2-7-事务传播"><a href="#1-2-7-事务传播" class="headerlink" title="1.2.7 事务传播"></a>1.2.7 事务传播</h3><p>本节描述Spring中事务传播的一些语义。请注意，本节并不是对事务传播的介绍;相反，它详细介绍了一些关于Spring中的事务传播的语义。</p>
<p>在spring管理的事务中，请注意物理事务和逻辑事务之间的差异，以及传播设置如何应用于这种差异。</p>
<h4 id="1-2-7-1-Required"><a href="#1-2-7-1-Required" class="headerlink" title="1.2.7.1 Required"></a>1.2.7.1 Required</h4><p><img src="https://docs.spring.io/spring/docs/5.0.8.RELEASE/spring-framework-reference/images/tx_prop_required.png" alt="tx prop required"></p>
<p><strong>PROPAGATION_REQUIRED</strong></p>
<p>PROPAGATION_REQUIRED强制一个物理事务:如果没有事务存在，则在本地执行当前作用域，或者参与为更大作用域定义的现有“外部”事务。</p>
<p>在相同线程内的公共调用堆栈安排中，这是一个很好的默认设置，例如，一个服务facade委托给多个存储库方法，其中所有底层资源都必须参与服务级事务。</p>
<p>默认情况下，<strong>参与的事务将连接外部作用域的特征</strong>，静默地忽略本地隔离级别、超时值或只读标志(如果有的话)。如果您希望在参与具有不同隔离级别的现有事务时拒绝隔离级别声明，请考虑将事务管理器上的“validateExistingTransactions”标记切换为“true”。这种非宽松模式还将拒绝只读不匹配，即试图参与只读外部作用域的内部读写事务。</p>
<p>当传播设置为PROPAGATION_REQUIRED时，为应用该设置的每个方法创建一个逻辑事务作用域。每个这样的逻辑事务作用域都可以单独确定只回滚的状态，外部事务作用域在逻辑上独立于内部事务作用域。当然，对于标准的PROPAGATION_REQUIRED行为，所有这些作用域将映射到相同的物理事务。因此，内部事务作用域中仅回滚的标记集确实会影响外部事务实际提交的机会(正如您所期望的那样)</p>
<p>但是，在内部事务作用域设置了只回滚标记的情况下，外部事务还没有决定回滚本身，因此回滚(由内部事务作用域无声触发)是意外的。在这一点上会抛出一个相应的出人意料的drollbackexception。这是预期的行为，因此，事务的调用者永远不能被误导，以为提交是在实际没有执行时执行的。因此，如果一个内部事务(外部调用者并不知道)悄无声息地将一个事务标记为仅回滚，外部调用者仍然调用commit。外部调用者需要接收到一个出人意料的drollbackexception异常，以清楚地表明执行了回滚。</p>
<h4 id="1-2-7-2-RequiresNew"><a href="#1-2-7-2-RequiresNew" class="headerlink" title="1.2.7.2 RequiresNew"></a>1.2.7.2 RequiresNew</h4><p><img src="https://docs.spring.io/spring/docs/5.0.8.RELEASE/spring-framework-reference/images/tx_prop_requires_new.png" alt="tx prop requires new"></p>
<h4 id="1-2-7-2-PROPAGATION-REQUIRES-NEW"><a href="#1-2-7-2-PROPAGATION-REQUIRES-NEW" class="headerlink" title="1.2.7.2 PROPAGATION_REQUIRES_NEW"></a>1.2.7.2 PROPAGATION_REQUIRES_NEW</h4><p><code>PROPAGATION_REQUIRES_NEW</code>, in contrast to <code>PROPAGATION_REQUIRED</code>, always uses an <em>independent</em> physical transaction for each affected transaction scope, never participating in an existing transaction for an outer scope. In such an arrangement, the underlying resource transactions are different and hence can commit or roll back independently, with an outer transaction not affected by an inner transaction’s rollback status, and with an inner transaction’s locks released immediately after its completion. Such an independent inner transaction may also declare its own isolation level, timeout and read-only settings, never inheriting an outer transaction’s characteristics.</p>
<h4 id="1-2-7-4-Nested"><a href="#1-2-7-4-Nested" class="headerlink" title="1.2.7.4 Nested"></a>1.2.7.4 Nested</h4><p><code>PROPAGATION_NESTED</code> uses a <em>single</em> physical transaction with multiple savepoints that it can roll back to. Such partial rollbacks allow an inner transaction scope to trigger a rollback <em>for its scope</em>, with the outer transaction being able to continue the physical transaction despite some operations having been rolled back. This setting is typically mapped onto JDBC savepoints, so will only work with JDBC resource transactions. See Spring’s <code>DataSourceTransactionManager</code>.</p>
<h2 id="1-3-编程式事务"><a href="#1-3-编程式事务" class="headerlink" title="1.3 编程式事务"></a>1.3 编程式事务</h2><h2 id="1-4-编程式VS声明式"><a href="#1-4-编程式VS声明式" class="headerlink" title="1.4 编程式VS声明式"></a>1.4 编程式VS声明式</h2><p>只有在有少量事务操作的情况下，程序化事务管理通常是一个好主意。例如，如果您的web应用程序只对某些更新操作需要事务，您可能不希望使用Spring或任何其他技术来设置事务代理。在这种情况下，使用TransactionTemplate可能是一种很好的方法。能够显式地设置事务名称也是只能使用事务管理的编程方法才能做到的事情。</p>
<p>另一方面，如果应用程序有许多事务操作，那么声明性事务管理通常是值得的。它将事务管理排除在业务逻辑之外，并且配置起来并不困难。当使用Spring框架而不是EJB CMT时，声明性事务管理的配置成本大大降低.</p>
<h2 id="1-5-Transaction-bound-event"><a href="#1-5-Transaction-bound-event" class="headerlink" title="1.5 Transaction bound event"></a>1.5 Transaction bound event</h2><p>As of Spring 4.2, the listener of an event can be bound to a phase of the transaction. The typical example is to handle the event when the transaction has completed successfully: this allows events to be used with more flexibility when the outcome of the current transaction actually matters to the listener.</p>
<p>Registering a regular event listener is done via the <code>@EventListener</code> annotation. If you need to bind it to the transaction use <code>@TransactionalEventListener</code>. When you do so, the listener will be bound to the commit phase of the transaction by default.</p>
<p>Let’s take an example to illustrate this concept. Assume that a component publishes an order created event and we want to define a listener that should only handle that event once the transaction in which it has been published has committed successfully:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyComponent</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TransactionalEventListener</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleOrderCreatedEvent</span><span class="params">(CreationEvent&lt;Order&gt; creationEvent)</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The <code>TransactionalEventListener</code> annotation exposes a <code>phase</code> attribute that allows us to customize which phase of the transaction the listener should be bound to. The valid phases are <code>BEFORE_COMMIT</code>, <code>AFTER_COMMIT</code> (default), <code>AFTER_ROLLBACK</code> and <code>AFTER_COMPLETION</code> that aggregates the transaction completion (be it a commit or a rollback).</p>
<p>If no transaction is running, the listener is not invoked at all since we can’t honor the required semantics. It is however possible to override that behaviour by setting the <code>fallbackExecution</code> attribute of the annotation to <code>true</code>.</p>
<h1 id="2-Dao-Support"><a href="#2-Dao-Support" class="headerlink" title="2 Dao Support"></a>2 Dao Support</h1><p>The Data Access Object (DAO) support in Spring is aimed at making it easy to work with data access technologies like JDBC, Hibernate or JPA in a consistent way. This allows one to switch between the aforementioned persistence technologies fairly easily and it also allows one to code without worrying about catching exceptions that are specific to each technology.</p>
<h2 id="2-1-一致的层级异常结构"><a href="#2-1-一致的层级异常结构" class="headerlink" title="2.1 一致的层级异常结构"></a>2.1 一致的层级异常结构</h2><p>Spring中的数据访问对象(Data Access Object, DAO)支持以一致的方式使用JDBC、Hibernate或JPA等数据访问技术。这允许您相当容易地在上述持久性技术之间进行切换，还允许您不必担心捕获特定于每种技术的异常。</p>
<p>除了JDBC异常，Spring还可以包装特定于hibernate的异常，将其转换为一组集中的运行时异常(JPA异常也是如此)。这允许您只在适当的层中处理大多数不可恢复的持久性异常，而不需要在DAOs中使用恼人的样板式catch-and-throw块和异常声明。(在任何需要的地方，仍然可以捕获和处理异常。)如上所述，JDBC异常(包括特定于数据库的方言)也被转换为相同的层次结构，这意味着可以在一致的编程模型中使用JDBC执行一些操作。</p>
<p>上述情况适用于各种ORM框架的spring支持中的各种模板类。如果使用基于拦截的类，那么应用程序必须关心如何处理hibernate异常和持久化异常本身，最好分别通过委托SessionFactoryUtils的convertHibernateAccessException(..)或convertJpaAccessException()方法来处理。这些方法将异常转换为与org.springframework中的异常兼容的异常。dao异常层次结构。由于持久化异常是未经检查的，因此它们也可能被抛出，但会牺牲泛型DAO抽象的异常。</p>
<h2 id="2-2-注解配置Dao"><a href="#2-2-注解配置Dao" class="headerlink" title="2.2 注解配置Dao"></a>2.2 注解配置Dao</h2><p>The best way to guarantee that your Data Access Objects (DAOs) or repositories provide exception translation is to use the <code>@Repository</code> annotation. This annotation also allows the component scanning support to find and configure your DAOs and repositories without having to provide XML configuration entries for them.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SomeMovieFinder</span> <span class="keyword">implements</span> <span class="title">MovieFinder</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Any DAO or repository implementation will need to access to a persistence resource, depending on the persistence technology used;</p>
<p> <strong>for example, a JDBC-based repository will need access to a JDBC <code>DataSource</code>;</strong> </p>
<p><strong>a JPA-based repository will need access to an <code>EntityManager</code>.</strong> </p>
<p>The easiest way to accomplish this is to have this resource dependency injected using one of the <code>@Autowired,</code>, <code>@Inject</code>, <code>@Resource</code> or <code>@PersistenceContext</code> annotations. Here is an example for a JPA repository:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JpaMovieFinder</span> <span class="keyword">implements</span> <span class="title">MovieFinder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PersistenceContext</span></span><br><span class="line">    <span class="keyword">private</span> EntityManager entityManager;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>If you are using the classic Hibernate APIs than you can inject the SessionFactory:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HibernateMovieFinder</span> <span class="keyword">implements</span> <span class="title">MovieFinder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> SessionFactory sessionFactory;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSessionFactory</span><span class="params">(SessionFactory sessionFactory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.sessionFactory = sessionFactory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Last example we will show here is for typical JDBC support. You would have the <code>DataSource</code> injected into an initialization method where you would create a <code>JdbcTemplate</code> and other data access support classes like <code>SimpleJdbcCall</code> etc using this <code>DataSource</code>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JdbcMovieFinder</span> <span class="keyword">implements</span> <span class="title">MovieFinder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(DataSource dataSource)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.jdbcTemplate = <span class="keyword">new</span> JdbcTemplate(dataSource);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="3-Data-access-with-JDBC"><a href="#3-Data-access-with-JDBC" class="headerlink" title="3 Data access with JDBC"></a>3 Data access with JDBC</h1><h2 id="3-1-JDBC-Support"><a href="#3-1-JDBC-Support" class="headerlink" title="3.1 JDBC Support"></a>3.1 JDBC Support</h2><table>
<thead>
<tr>
<th>Action</th>
<th>Spring</th>
<th>You</th>
</tr>
</thead>
<tbody><tr>
<td>Define connection parameters.</td>
<td></td>
<td>X</td>
</tr>
<tr>
<td>Open the connection.</td>
<td>X</td>
<td></td>
</tr>
<tr>
<td>Specify the SQL statement.</td>
<td></td>
<td>X</td>
</tr>
<tr>
<td>Declare parameters and provide parameter values</td>
<td></td>
<td>X</td>
</tr>
<tr>
<td>Prepare and execute the statement.</td>
<td>X</td>
<td></td>
</tr>
<tr>
<td>Set up the loop to iterate through the results (if any).</td>
<td>X</td>
<td></td>
</tr>
<tr>
<td>Do the work for each iteration.</td>
<td></td>
<td>X</td>
</tr>
<tr>
<td>Process any exception.</td>
<td>X</td>
<td></td>
</tr>
<tr>
<td>Handle transactions.</td>
<td>X</td>
<td></td>
</tr>
<tr>
<td>Close the connection, statement and resultset.</td>
<td>X</td>
<td></td>
</tr>
</tbody></table>
<p>Spring框架处理了所有底层细节，这些细节使JDBC成为一个乏味的API。</p>
<h2 id="3-2-访问JDBC数据库的方式"><a href="#3-2-访问JDBC数据库的方式" class="headerlink" title="3.2 访问JDBC数据库的方式"></a>3.2 访问JDBC数据库的方式</h2><p>You can choose among several approaches to form the basis for your JDBC database access. In addition to three flavors of the JdbcTemplate, a new SimpleJdbcInsert and SimplejdbcCall approach optimizes database metadata, and the RDBMS Object style takes a more object-oriented approach similar to that of JDO Query design. Once you start using one of these approaches, you can still mix and match to include a feature from a different approach. All approaches require a JDBC 2.0-compliant driver, and some advanced features require a JDBC 3.0 driver.</p>
<ul>
<li><strong><em>JdbcTemplate</em></strong> is the classic Spring JDBC approach and the most popular. This “lowest level” approach and all others use a JdbcTemplate under the covers.</li>
<li><strong><em>NamedParameterJdbcTemplate</em></strong> wraps a <code>JdbcTemplate</code> to provide named parameters instead of the traditional JDBC “?” placeholders. This approach provides better documentation and ease of use when you have multiple parameters for an SQL statement.</li>
<li><strong><em>SimpleJdbcInsert and SimpleJdbcCall</em></strong> optimize database metadata to limit the amount of necessary configuration. This approach simplifies coding so that you only need to provide the name of the table or procedure and provide a map of parameters matching the column names. This only works if the database provides adequate metadata. If the database doesn’t provide this metadata, you will have to provide explicit configuration of the parameters.</li>
<li><strong>RDBMS Objects</strong> including MappingSqlQuery, SqlUpdate and StoredProcedure* requires you to create reusable and thread-safe objects during initialization of your data access layer. This approach is modeled after JDO Query wherein you define your query string, declare parameters, and compile the query. Once you do that, execute methods can be called multiple times with various parameter values passed in.</li>
</ul>
<h3 id="3-2-1-JdbcTemplate"><a href="#3-2-1-JdbcTemplate" class="headerlink" title="3.2.1 JdbcTemplate"></a>3.2.1 JdbcTemplate</h3><p>JdbcTemplate类是JDBC核心包中的中心类。它处理资源的创建和释放，帮助您避免常见错误，例如忘记关闭连接。它执行核心JDBC工作流的基本任务，如语句的创建和执行，留下应用程序代码提供SQL和提取结果。JdbcTemplate类执行SQL查询、更新语句和存储过程调用，执行结果集的迭代和返回参数值的提取。</p>
<p>It also catches JDBC exceptions and translates them to the generic(通用), more informative（信息丰富）, exception hierarchy defined in the <code>org.springframework.dao</code> package.</p>
<ul>
<li><strong>查询</strong></li>
</ul>
<p>Here is a simple query for getting the number of rows in a relation:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> rowCount = <span class="keyword">this</span>.jdbcTemplate.queryForObject(<span class="string">"select count(*) from t_actor"</span>, Integer<span class="class">.<span class="keyword">class</span>)</span>;</span><br></pre></td></tr></table></figure>

<p>A simple query using a bind variable:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> countOfActorsNamedJoe = <span class="keyword">this</span>.jdbcTemplate.queryForObject(</span><br><span class="line">        "select count(*) from t_actor where first_name = ?", Integer.class, "Joe");</span><br></pre></td></tr></table></figure>

<p>Querying for a <code>String</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">String lastName &#x3D; this.jdbcTemplate.queryForObject(</span><br><span class="line">        &quot;select last_name from t_actor where id &#x3D; ?&quot;,</span><br><span class="line">        new Object[]&#123;1212L&#125;, String.class);</span><br></pre></td></tr></table></figure>

<p>Querying and populating a <em>single</em> <strong>domain</strong> object:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Actor actor = <span class="keyword">this</span>.jdbcTemplate.queryForObject(</span><br><span class="line">        <span class="string">"select first_name, last_name from t_actor where id = ?"</span>,</span><br><span class="line">        <span class="keyword">new</span> Object[]&#123;<span class="number">1212L</span>&#125;,</span><br><span class="line">        <span class="keyword">new</span> RowMapper&lt;Actor&gt;() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> Actor <span class="title">mapRow</span><span class="params">(ResultSet rs, <span class="keyword">int</span> rowNum)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">                Actor actor = <span class="keyword">new</span> Actor();</span><br><span class="line">                actor.setFirstName(rs.getString(<span class="string">"first_name"</span>));</span><br><span class="line">                actor.setLastName(rs.getString(<span class="string">"last_name"</span>));</span><br><span class="line">                <span class="keyword">return</span> actor;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>

<p>Querying and populating a number of domain objects:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Actor&gt; actors = <span class="keyword">this</span>.jdbcTemplate.query(</span><br><span class="line">        <span class="string">"select first_name, last_name from t_actor"</span>,</span><br><span class="line">        <span class="keyword">new</span> RowMapper&lt;Actor&gt;() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> Actor <span class="title">mapRow</span><span class="params">(ResultSet rs, <span class="keyword">int</span> rowNum)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">                Actor actor = <span class="keyword">new</span> Actor();</span><br><span class="line">                actor.setFirstName(rs.getString(<span class="string">"first_name"</span>));</span><br><span class="line">                actor.setLastName(rs.getString(<span class="string">"last_name"</span>));</span><br><span class="line">                <span class="keyword">return</span> actor;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>

<p>If the last two snippets of code actually existed in the same application, it would make sense to remove the duplication present in the two <code>RowMapper</code> anonymous inner classes, and extract them out into a single class (typically a <code>static</code> nested class) that can then be referenced by DAO methods as needed. For example, it may be better to write the last code snippet as follows:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Actor&gt; <span class="title">findAllActors</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.jdbcTemplate.query( <span class="string">"select first_name, last_name from t_actor"</span>, <span class="keyword">new</span> ActorMapper());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ActorMapper</span> <span class="keyword">implements</span> <span class="title">RowMapper</span>&lt;<span class="title">Actor</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Actor <span class="title">mapRow</span><span class="params">(ResultSet rs, <span class="keyword">int</span> rowNum)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">        Actor actor = <span class="keyword">new</span> Actor();</span><br><span class="line">        actor.setFirstName(rs.getString(<span class="string">"first_name"</span>));</span><br><span class="line">        actor.setLastName(rs.getString(<span class="string">"last_name"</span>));</span><br><span class="line">        <span class="keyword">return</span> actor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>Updating (INSERT/UPDATE/DELETE) with JdbcTemplate</strong></li>
</ul>
<p>You use the <code>update(..)</code> method to perform insert, update and delete operations. Parameter values are usually provided as var args or alternatively as an object array.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.jdbcTemplate.update(</span><br><span class="line">        <span class="string">"insert into t_actor (first_name, last_name) values (?, ?)"</span>,</span><br><span class="line">        <span class="string">"Leonor"</span>, <span class="string">"Watling"</span>);</span><br><span class="line"><span class="keyword">this</span>.jdbcTemplate.update(</span><br><span class="line">        <span class="string">"update t_actor set last_name = ? where id = ?"</span>,</span><br><span class="line">        <span class="string">"Banjo"</span>, <span class="number">5276L</span>);</span><br><span class="line"><span class="keyword">this</span>.jdbcTemplate.update(</span><br><span class="line">        <span class="string">"delete from actor where id = ?"</span>,</span><br><span class="line">        Long.valueOf(actorId));</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>Other JdbcTemplate operations</strong></li>
</ul>
<p>You can use the <code>execute(..)</code> method to execute any arbitrary SQL, and as such the method is often used for DDL statements. It is heavily overloaded with variants taking callback interfaces, binding variable arrays, and so on.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">this.jdbcTemplate.execute(&quot;create table mytable (id integer, name varchar(100))&quot;);</span><br></pre></td></tr></table></figure>

<p>The following example invokes a simple stored procedure. More sophisticated stored procedure support is <span class="exturl" data-url="aHR0cHM6Ly9kb2NzLnNwcmluZy5pby9zcHJpbmcvZG9jcy81LjAuOC5SRUxFQVNFL3NwcmluZy1mcmFtZXdvcmstcmVmZXJlbmNlL2RhdGEtYWNjZXNzLmh0bWwjamRiYy1TdG9yZWRQcm9jZWR1cmU=" title="https://docs.spring.io/spring/docs/5.0.8.RELEASE/spring-framework-reference/data-access.html#jdbc-StoredProcedure">covered later<i class="fa fa-external-link"></i></span>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.jdbcTemplate.update(</span><br><span class="line">        <span class="string">"call SUPPORT.REFRESH_ACTORS_SUMMARY(?)"</span>,</span><br><span class="line">        Long.valueOf(unionId));</span><br></pre></td></tr></table></figure>

<h3 id="3-2-2-NamedParameterJdbcTemplate"><a href="#3-2-2-NamedParameterJdbcTemplate" class="headerlink" title="3.2.2 NamedParameterJdbcTemplate"></a>3.2.2 NamedParameterJdbcTemplate</h3><p>The <code>NamedParameterJdbcTemplate</code> class adds support for programming JDBC statements using named parameters, as opposed to programming JDBC statements using only classic placeholder ( <code>&#39;?&#39;</code>) arguments. The <code>NamedParameterJdbcTemplate</code> class wraps a <code>JdbcTemplate</code>, and delegates to the wrapped <code>JdbcTemplate</code> to do much of its work. This section describes only those areas of the <code>NamedParameterJdbcTemplate</code> class that differ from the <code>JdbcTemplate</code> itself; namely, programming JDBC statements using named parameters.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// some JDBC-backed DAO class...</span></span><br><span class="line"><span class="keyword">private</span> NamedParameterJdbcTemplate namedParameterJdbcTemplate;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDataSource</span><span class="params">(DataSource dataSource)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.namedParameterJdbcTemplate = <span class="keyword">new</span> NamedParameterJdbcTemplate(dataSource);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">countOfActorsByFirstName</span><span class="params">(String firstName)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    String sql = <span class="string">"select count(*) from T_ACTOR where first_name = :first_name"</span>;</span><br><span class="line"></span><br><span class="line">    SqlParameterSource namedParameters = <span class="keyword">new</span> MapSqlParameterSource(<span class="string">"first_name"</span>, firstName);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.namedParameterJdbcTemplate.queryForObject(sql, namedParameters, Integer<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Notice the use of the named parameter notation in the value assigned to the <code>sql</code> variable, and the corresponding value that is plugged into the <code>namedParameters</code> variable (of type <code>MapSqlParameterSource</code>).</p>
<p>Alternatively, you can pass along named parameters and their corresponding values to a <code>NamedParameterJdbcTemplate</code> instance by using the <code>Map</code>-based style.The remaining methods exposed by the <code>NamedParameterJdbcOperations</code> and implemented by the<code>NamedParameterJdbcTemplate</code> class follow a similar pattern and are not covered here.</p>
<p>The following example shows the use of the <code>Map</code>-based style.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// some JDBC-backed DAO class...</span></span><br><span class="line"><span class="keyword">private</span> NamedParameterJdbcTemplate namedParameterJdbcTemplate;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDataSource</span><span class="params">(DataSource dataSource)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.namedParameterJdbcTemplate = <span class="keyword">new</span> NamedParameterJdbcTemplate(dataSource);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">countOfActorsByFirstName</span><span class="params">(String firstName)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    String sql = <span class="string">"select count(*) from T_ACTOR where first_name = :first_name"</span>;</span><br><span class="line"></span><br><span class="line">    Map&lt;String, String&gt; namedParameters = Collections.singletonMap(<span class="string">"first_name"</span>, firstName);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.namedParameterJdbcTemplate.queryForObject(sql, namedParameters,  Integer<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>One nice feature related to the <code>NamedParameterJdbcTemplate</code> (and existing in the same Java package) is the <code>SqlParameterSource</code>interface. </p>
<p>You have already seen an example of an implementation of this interface in one of the previous code snippet (the<code>MapSqlParameterSource</code> class). </p>
<p>An <code>SqlParameterSource</code> is a source of named parameter values to a <code>NamedParameterJdbcTemplate</code>. The <code>MapSqlParameterSource</code> class is a very simple implementation that is simply an adapter around a <code>java.util.Map</code>, where the keys are the parameter names and the values are the parameter values.</p>
<p>Another <code>SqlParameterSource</code> implementation is the <code>BeanPropertySqlParameterSource</code> class. This class wraps an arbitrary JavaBean (that is, an instance of a class that adheres to <span class="exturl" data-url="aHR0cDovL3d3dy5vcmFjbGUuY29tL3RlY2huZXR3b3JrL2phdmEvamF2YXNlL2RvY3VtZW50YXRpb24vc3BlYy0xMzYwMDQuaHRtbA==" title="http://www.oracle.com/technetwork/java/javase/documentation/spec-136004.html">the JavaBean conventions<i class="fa fa-external-link"></i></span>), and uses the properties of the wrapped JavaBean as the source of named parameter values.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Actor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String firstName;</span><br><span class="line">    <span class="keyword">private</span> String lastName;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getFirstName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.firstName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getLastName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.lastName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// setters omitted...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// some JDBC-backed DAO class...</span></span><br><span class="line"><span class="keyword">private</span> NamedParameterJdbcTemplate namedParameterJdbcTemplate;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDataSource</span><span class="params">(DataSource dataSource)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.namedParameterJdbcTemplate = <span class="keyword">new</span> NamedParameterJdbcTemplate(dataSource);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">countOfActors</span><span class="params">(Actor exampleActor)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// notice how the named parameters match the properties of the above 'Actor' class</span></span><br><span class="line">    String sql = <span class="string">"select count(*) from T_ACTOR where first_name = :firstName and last_name = :lastName"</span>;</span><br><span class="line"></span><br><span class="line">    SqlParameterSource namedParameters = <span class="keyword">new</span> BeanPropertySqlParameterSource(exampleActor);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.namedParameterJdbcTemplate.queryForObject(sql, namedParameters, Integer<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Remember that the <code>NamedParameterJdbcTemplate</code> class <em>wraps</em> a classic <code>JdbcTemplate</code> template;</p>
<p> if you need access to the wrapped <code>JdbcTemplate</code> instance to access functionality only present in the <code>JdbcTemplate</code> class, you can use the<code>getJdbcOperations()</code> method to access the wrapped <code>JdbcTemplate</code> through the <code>JdbcOperations</code> interface.</p>
<h2 id="3-3-SQLExceptionTranslator"><a href="#3-3-SQLExceptionTranslator" class="headerlink" title="3.3 SQLExceptionTranslator"></a>3.3 SQLExceptionTranslator</h2><p>The <code>SQLErrorCodeSQLExceptionTranslator</code> applies matching rules in the following sequence:</p>
<ul>
<li>Any custom translation implemented by a subclass. Normally the provided concrete <code>SQLErrorCodeSQLExceptionTranslator</code> is used so this rule does not apply. It only applies if you have actually provided a subclass implementation.</li>
<li>Any custom implementation of the <code>SQLExceptionTranslator</code> interface that is provided as the <code>customSqlExceptionTranslator</code>property of the <code>SQLErrorCodes</code> class.</li>
<li>The list of instances of the <code>CustomSQLErrorCodesTranslation</code> class, provided for the <code>customTranslations</code> property of the <code>SQLErrorCodes</code> class, are searched for a match.</li>
<li>Error code matching is applied.</li>
<li>Use the fallback translator. <code>SQLExceptionSubclassTranslator</code> is the default fallback translator. If this translation is not available then the next fallback translator is the <code>SQLStateSQLExceptionTranslator</code>.</li>
</ul>
<p>You can extend <code>SQLErrorCodeSQLExceptionTranslator:</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomSQLErrorCodesTranslator</span> <span class="keyword">extends</span> <span class="title">SQLErrorCodeSQLExceptionTranslator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> DataAccessException <span class="title">customTranslate</span><span class="params">(String task, String sql, SQLException sqlex)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (sqlex.getErrorCode() == -<span class="number">12345</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> DeadlockLoserDataAccessException(task, sqlex);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>In this example, the specific error code <code>-12345</code> is translated and other errors are left to be translated by the default translator implementation. To use this custom translator, it is necessary to pass it to the <code>JdbcTemplate</code> through the method<code>setExceptionTranslator</code> and to use this <code>JdbcTemplate</code> for all of the data access processing where this translator is needed. Here is an example of how this custom translator can be used:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDataSource</span><span class="params">(DataSource dataSource)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// create a JdbcTemplate and set data source</span></span><br><span class="line">    <span class="keyword">this</span>.jdbcTemplate = <span class="keyword">new</span> JdbcTemplate();</span><br><span class="line">    <span class="keyword">this</span>.jdbcTemplate.setDataSource(dataSource);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// create a custom translator and set the DataSource for the default translation lookup</span></span><br><span class="line">    CustomSQLErrorCodesTranslator tr = <span class="keyword">new</span> CustomSQLErrorCodesTranslator();</span><br><span class="line">    tr.setDataSource(dataSource);</span><br><span class="line">    <span class="keyword">this</span>.jdbcTemplate.setExceptionTranslator(tr);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateShippingCharge</span><span class="params">(<span class="keyword">long</span> orderId, <span class="keyword">long</span> pct)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// use the prepared JdbcTemplate for this update</span></span><br><span class="line">    <span class="keyword">this</span>.jdbcTemplate.update(<span class="string">"update orders"</span> +</span><br><span class="line">        <span class="string">" set shipping_charge = shipping_charge * ? / 100"</span> +</span><br><span class="line">        <span class="string">" where id = ?"</span>, pct, orderId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The custom translator is passed a data source in order to look up the error codes in <code>sql-error-codes.xml</code>.</p>
<h2 id="3-4-Retrieving-auto-generated-keys"><a href="#3-4-Retrieving-auto-generated-keys" class="headerlink" title="3.4 Retrieving auto-generated keys"></a>3.4 Retrieving auto-generated keys</h2><p>An <code>update()</code> convenience method supports the retrieval of primary keys generated by the database. This support is part of the JDBC 3.0 standard; see Chapter 13.6 of the specification for details. The method takes a <code>PreparedStatementCreator</code> as its first argument, and this is the way the required insert statement is specified. The other argument is a <code>KeyHolder</code>, which contains the generated key on successful return from the update. There is not a standard single way to create an appropriate <code>PreparedStatement</code> (which explains why the method signature is the way it is). The following example works on Oracle but may not work on other platforms:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> String INSERT_SQL = <span class="string">"insert into my_test (name) values(?)"</span>;</span><br><span class="line"><span class="keyword">final</span> String name = <span class="string">"Rob"</span>;</span><br><span class="line"></span><br><span class="line">KeyHolder keyHolder = <span class="keyword">new</span> GeneratedKeyHolder();</span><br><span class="line">jdbcTemplate.update(</span><br><span class="line">    <span class="keyword">new</span> PreparedStatementCreator() &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> PreparedStatement <span class="title">createPreparedStatement</span><span class="params">(Connection connection)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">            PreparedStatement ps = connection.prepareStatement(INSERT_SQL, <span class="keyword">new</span> String[] &#123;<span class="string">"id"</span>&#125;);</span><br><span class="line">            ps.setString(<span class="number">1</span>, name);</span><br><span class="line">            <span class="keyword">return</span> ps;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    keyHolder);</span><br><span class="line"></span><br><span class="line"><span class="comment">// keyHolder.getKey() now contains the generated key</span></span><br></pre></td></tr></table></figure>

<h2 id="3-5-数据源连接管理"><a href="#3-5-数据源连接管理" class="headerlink" title="3.5 数据源连接管理"></a>3.5 数据源连接管理</h2><p>You obtain a connection with <code>DriverManagerDataSource</code> as you typically obtain a JDBC connection. Specify the fully qualified classname of the JDBC driver so that the <code>DriverManager</code> can load the driver class. Next, provide a URL that varies between JDBC drivers. (Consult the documentation for your driver for the correct value.) Then provide a username and a password to connect to the database. Here is an example of how to configure a <code>DriverManagerDataSource</code> in Java code:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">DriverManagerDataSource dataSource = <span class="keyword">new</span> DriverManagerDataSource();</span><br><span class="line">dataSource.setDriverClassName(<span class="string">"org.hsqldb.jdbcDriver"</span>);</span><br><span class="line">dataSource.setUrl(<span class="string">"jdbc:hsqldb:hsql://localhost:"</span>);</span><br><span class="line">dataSource.setUsername(<span class="string">"sa"</span>);</span><br><span class="line">dataSource.setPassword(<span class="string">""</span>);</span><br></pre></td></tr></table></figure>

<p>Here is the corresponding XML configuration:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"dataSource"</span> <span class="attr">class</span>=<span class="string">"org.springframework.jdbc.datasource.DriverManagerDataSource"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driverClassName"</span> <span class="attr">value</span>=<span class="string">"$&#123;jdbc.driverClassName&#125;"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"$&#123;jdbc.url&#125;"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"$&#123;jdbc.username&#125;"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"$&#123;jdbc.password&#125;"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">context:property-placeholder</span> <span class="attr">location</span>=<span class="string">"jdbc.properties"</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>The following examples show the basic connectivity and configuration for DBCP and C3P0. To learn about more options that help control the pooling features, see the product documentation for the respective connection pooling implementations.</p>
<p>DBCP configuration:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"dataSource"</span> <span class="attr">class</span>=<span class="string">"org.apache.commons.dbcp.BasicDataSource"</span> <span class="attr">destroy-method</span>=<span class="string">"close"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driverClassName"</span> <span class="attr">value</span>=<span class="string">"$&#123;jdbc.driverClassName&#125;"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"$&#123;jdbc.url&#125;"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"$&#123;jdbc.username&#125;"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"$&#123;jdbc.password&#125;"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">context:property-placeholder</span> <span class="attr">location</span>=<span class="string">"jdbc.properties"</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>C3P0 configuration:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"dataSource"</span> <span class="attr">class</span>=<span class="string">"com.mchange.v2.c3p0.ComboPooledDataSource"</span> <span class="attr">destroy-method</span>=<span class="string">"close"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driverClass"</span> <span class="attr">value</span>=<span class="string">"$&#123;jdbc.driverClassName&#125;"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jdbcUrl"</span> <span class="attr">value</span>=<span class="string">"$&#123;jdbc.url&#125;"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"user"</span> <span class="attr">value</span>=<span class="string">"$&#123;jdbc.username&#125;"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"$&#123;jdbc.password&#125;"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">context:property-placeholder</span> <span class="attr">location</span>=<span class="string">"jdbc.properties"</span>/&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="3-6-JDBC批量操作"><a href="#3-6-JDBC批量操作" class="headerlink" title="3.6 JDBC批量操作"></a>3.6 JDBC批量操作</h2><ul>
<li><p>通过jdbcTemplate</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JdbcActorDao</span> <span class="keyword">implements</span> <span class="title">ActorDao</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDataSource</span><span class="params">(DataSource dataSource)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.jdbcTemplate = <span class="keyword">new</span> JdbcTemplate(dataSource);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span>[] batchUpdate(<span class="keyword">final</span> List&lt;Actor&gt; actors) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.jdbcTemplate.batchUpdate(</span><br><span class="line">                <span class="string">"update t_actor set first_name = ?, last_name = ? where id = ?"</span>,</span><br><span class="line">                <span class="keyword">new</span> BatchPreparedStatementSetter() &#123;</span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setValues</span><span class="params">(PreparedStatement ps, <span class="keyword">int</span> i)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">                        ps.setString(<span class="number">1</span>, actors.get(i).getFirstName());</span><br><span class="line">                        ps.setString(<span class="number">2</span>, actors.get(i).getLastName());</span><br><span class="line">                        ps.setLong(<span class="number">3</span>, actors.get(i).getId().longValue());</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getBatchSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        <span class="keyword">return</span> actors.size();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ... additional methods</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><h4 id="with-a-List-of-objects"><a href="#with-a-List-of-objects" class="headerlink" title="with a List of objects"></a>with a List of objects</h4></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JdbcActorDao</span> <span class="keyword">implements</span> <span class="title">ActorDao</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> NamedParameterTemplate namedParameterJdbcTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDataSource</span><span class="params">(DataSource dataSource)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.namedParameterJdbcTemplate = <span class="keyword">new</span> NamedParameterJdbcTemplate(dataSource);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span>[] batchUpdate(List&lt;Actor&gt; actors) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.namedParameterJdbcTemplate.batchUpdate(</span><br><span class="line">                <span class="string">"update t_actor set first_name = :firstName, last_name = :lastName where id = :id"</span>,</span><br><span class="line">                SqlParameterSourceUtils.createBatch(actors));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ... additional methods</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The same example using classic JDBC “?” placeholders:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JdbcActorDao</span> <span class="keyword">implements</span> <span class="title">ActorDao</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDataSource</span><span class="params">(DataSource dataSource)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.jdbcTemplate = <span class="keyword">new</span> JdbcTemplate(dataSource);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span>[] batchUpdate(<span class="keyword">final</span> List&lt;Actor&gt; actors) &#123;</span><br><span class="line">        List&lt;Object[]&gt; batch = <span class="keyword">new</span> ArrayList&lt;Object[]&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Actor actor : actors) &#123;</span><br><span class="line">            Object[] values = <span class="keyword">new</span> Object[] &#123;</span><br><span class="line">                    actor.getFirstName(), actor.getLastName(), actor.getId()&#125;;</span><br><span class="line">            batch.add(values);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.jdbcTemplate.batchUpdate(</span><br><span class="line">                <span class="string">"update t_actor set first_name = ?, last_name = ? where id = ?"</span>,</span><br><span class="line">                batch);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ... additional methods</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><h4 id="with-multiple-batches"><a href="#with-multiple-batches" class="headerlink" title="with multiple batches"></a>with multiple batches</h4></li>
</ul>
<p>This example shows a batch update using a batch size of 100:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JdbcActorDao</span> <span class="keyword">implements</span> <span class="title">ActorDao</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDataSource</span><span class="params">(DataSource dataSource)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.jdbcTemplate = <span class="keyword">new</span> JdbcTemplate(dataSource);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span>[][] batchUpdate(<span class="keyword">final</span> Collection&lt;Actor&gt; actors) &#123;</span><br><span class="line">        <span class="keyword">int</span>[][] updateCounts = jdbcTemplate.batchUpdate(</span><br><span class="line">                <span class="string">"update t_actor set first_name = ?, last_name = ? where id = ?"</span>,</span><br><span class="line">                actors,</span><br><span class="line">                <span class="number">100</span>,</span><br><span class="line">                <span class="keyword">new</span> ParameterizedPreparedStatementSetter&lt;Actor&gt;() &#123;</span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setValues</span><span class="params">(PreparedStatement ps, Actor argument)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">                        ps.setString(<span class="number">1</span>, argument.getFirstName());</span><br><span class="line">                        ps.setString(<span class="number">2</span>, argument.getLastName());</span><br><span class="line">                        ps.setLong(<span class="number">3</span>, argument.getId().longValue());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">        <span class="keyword">return</span> updateCounts;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ... additional methods</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="3-7-Simplifying-JDBC-operations-with-the-SimpleJdbc-classes"><a href="#3-7-Simplifying-JDBC-operations-with-the-SimpleJdbc-classes" class="headerlink" title="3.7 Simplifying JDBC operations with the SimpleJdbc classes"></a>3.7 Simplifying JDBC operations with the SimpleJdbc classes</h2><p>The <code>SimpleJdbcInsert</code> and <code>SimpleJdbcCall</code> classes provide a simplified configuration by taking advantage of database metadata that can be retrieved through the JDBC driver. This means there is less to configure up front, although you can override or turn off the metadata processing if you prefer to provide all the details in your code.</p>
<h3 id="3-7-1-使用SimpleJdbcInsert插入数据"><a href="#3-7-1-使用SimpleJdbcInsert插入数据" class="headerlink" title="3.7.1 使用SimpleJdbcInsert插入数据"></a>3.7.1 使用SimpleJdbcInsert插入数据</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JdbcActorDao</span> <span class="keyword">implements</span> <span class="title">ActorDao</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> JdbcTemplate jdbcTemplate;</span><br><span class="line">    <span class="keyword">private</span> SimpleJdbcInsert insertActor;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDataSource</span><span class="params">(DataSource dataSource)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.jdbcTemplate = <span class="keyword">new</span> JdbcTemplate(dataSource);</span><br><span class="line">        <span class="keyword">this</span>.insertActor = <span class="keyword">new</span> SimpleJdbcInsert(dataSource).withTableName(<span class="string">"t_actor"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(Actor actor)</span> </span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; parameters = <span class="keyword">new</span> HashMap&lt;String, Object&gt;(<span class="number">3</span>);</span><br><span class="line">        parameters.put(<span class="string">"id"</span>, actor.getId());</span><br><span class="line">        parameters.put(<span class="string">"first_name"</span>, actor.getFirstName());</span><br><span class="line">        parameters.put(<span class="string">"last_name"</span>, actor.getLastName());</span><br><span class="line">        insertActor.execute(parameters);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ... additional methods</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The execute method used here takes a plain <code>java.utils.Map</code> as its only parameter. The important thing to note here is that the keys used for the Map must match the column names of the table as defined in the database. This is because we read the metadata in order to construct the actual insert statement.</p>
<h3 id="3-7-2-使用SimpleJdbcInsert获取自增长值"><a href="#3-7-2-使用SimpleJdbcInsert获取自增长值" class="headerlink" title="3.7.2 使用SimpleJdbcInsert获取自增长值"></a>3.7.2 使用SimpleJdbcInsert获取自增长值</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JdbcActorDao</span> <span class="keyword">implements</span> <span class="title">ActorDao</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> JdbcTemplate jdbcTemplate;</span><br><span class="line">    <span class="keyword">private</span> SimpleJdbcInsert insertActor;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDataSource</span><span class="params">(DataSource dataSource)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.jdbcTemplate = <span class="keyword">new</span> JdbcTemplate(dataSource);</span><br><span class="line">        <span class="keyword">this</span>.insertActor = <span class="keyword">new</span> SimpleJdbcInsert(dataSource)</span><br><span class="line">                .withTableName(<span class="string">"t_actor"</span>)</span><br><span class="line">                .usingGeneratedKeyColumns(<span class="string">"id"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(Actor actor)</span> </span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; parameters = <span class="keyword">new</span> HashMap&lt;String, Object&gt;(<span class="number">2</span>);</span><br><span class="line">        parameters.put(<span class="string">"first_name"</span>, actor.getFirstName());</span><br><span class="line">        parameters.put(<span class="string">"last_name"</span>, actor.getLastName());</span><br><span class="line">        <span class="comment">// huoqu</span></span><br><span class="line">        Number newId = insertActor.executeAndReturnKey(parameters);</span><br><span class="line">        actor.setId(newId.longValue());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ... additional methods</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3-7-3-Specifying-columns-for-a-SimpleJdbcInsert"><a href="#3-7-3-Specifying-columns-for-a-SimpleJdbcInsert" class="headerlink" title="3.7.3 Specifying columns for a SimpleJdbcInsert"></a>3.7.3 Specifying columns for a SimpleJdbcInsert</h3><p>You can limit the columns for an insert by specifying a list of column names with the <code>usingColumns</code> method:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JdbcActorDao</span> <span class="keyword">implements</span> <span class="title">ActorDao</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> JdbcTemplate jdbcTemplate;</span><br><span class="line">    <span class="keyword">private</span> SimpleJdbcInsert insertActor;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDataSource</span><span class="params">(DataSource dataSource)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.jdbcTemplate = <span class="keyword">new</span> JdbcTemplate(dataSource);</span><br><span class="line">        <span class="keyword">this</span>.insertActor = <span class="keyword">new</span> SimpleJdbcInsert(dataSource)</span><br><span class="line">                .withTableName(<span class="string">"t_actor"</span>)</span><br><span class="line">                .usingColumns(<span class="string">"first_name"</span>, <span class="string">"last_name"</span>)</span><br><span class="line">                .usingGeneratedKeyColumns(<span class="string">"id"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(Actor actor)</span> </span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; parameters = <span class="keyword">new</span> HashMap&lt;String, Object&gt;(<span class="number">2</span>);</span><br><span class="line">        parameters.put(<span class="string">"first_name"</span>, actor.getFirstName());</span><br><span class="line">        parameters.put(<span class="string">"last_name"</span>, actor.getLastName());</span><br><span class="line">        Number newId = insertActor.executeAndReturnKey(parameters);</span><br><span class="line">        actor.setId(newId.longValue());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ... additional methods</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The execution of the insert is the same as if you had relied on the metadata to determine which columns to use.</p>
<h3 id="3-7-4-Using-SqlParameterSource-to-provide-parameter-values"><a href="#3-7-4-Using-SqlParameterSource-to-provide-parameter-values" class="headerlink" title="3.7.4 Using SqlParameterSource to provide parameter values"></a>3.7.4 Using SqlParameterSource to provide parameter values</h3><p>Using a <code>Map</code> to provide parameter values works fine, but it’s not the most convenient class to use. Spring provides a couple of implementations of the <code>SqlParameterSource</code> interface that can be used instead.The first one is <code>BeanPropertySqlParameterSource</code>, which is a very convenient class if you have a JavaBean-compliant class that contains your values. It will use the corresponding getter method to extract the parameter values. Here is an example:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JdbcActorDao</span> <span class="keyword">implements</span> <span class="title">ActorDao</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> JdbcTemplate jdbcTemplate;</span><br><span class="line">    <span class="keyword">private</span> SimpleJdbcInsert insertActor;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDataSource</span><span class="params">(DataSource dataSource)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.jdbcTemplate = <span class="keyword">new</span> JdbcTemplate(dataSource);</span><br><span class="line">        <span class="keyword">this</span>.insertActor = <span class="keyword">new</span> SimpleJdbcInsert(dataSource)</span><br><span class="line">                .withTableName(<span class="string">"t_actor"</span>)</span><br><span class="line">                .usingGeneratedKeyColumns(<span class="string">"id"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(Actor actor)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 使用</span></span><br><span class="line">        SqlParameterSource parameters = <span class="keyword">new</span> BeanPropertySqlParameterSource(actor);</span><br><span class="line">        Number newId = insertActor.executeAndReturnKey(parameters);</span><br><span class="line">        actor.setId(newId.longValue());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ... additional methods</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Another option is the <code>MapSqlParameterSource</code> that resembles a Map but provides a more convenient <code>addValue</code> method that can be chained.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JdbcActorDao</span> <span class="keyword">implements</span> <span class="title">ActorDao</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> JdbcTemplate jdbcTemplate;</span><br><span class="line">    <span class="keyword">private</span> SimpleJdbcInsert insertActor;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDataSource</span><span class="params">(DataSource dataSource)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.jdbcTemplate = <span class="keyword">new</span> JdbcTemplate(dataSource);</span><br><span class="line">        <span class="keyword">this</span>.insertActor = <span class="keyword">new</span> SimpleJdbcInsert(dataSource)</span><br><span class="line">                .withTableName(<span class="string">"t_actor"</span>)</span><br><span class="line">                .usingGeneratedKeyColumns(<span class="string">"id"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(Actor actor)</span> </span>&#123;</span><br><span class="line">        SqlParameterSource parameters = <span class="keyword">new</span> MapSqlParameterSource()</span><br><span class="line">                .addValue(<span class="string">"first_name"</span>, actor.getFirstName())</span><br><span class="line">                .addValue(<span class="string">"last_name"</span>, actor.getLastName());</span><br><span class="line">        Number newId = insertActor.executeAndReturnKey(parameters);</span><br><span class="line">        actor.setId(newId.longValue());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ... additional methods</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>As you can see, the configuration is the same; only the executing code has to change to use these alternative input classes.</p>
<h3 id="3-7-5-使用SimpleJdbcCall"><a href="#3-7-5-使用SimpleJdbcCall" class="headerlink" title="3.7.5 使用SimpleJdbcCall"></a>3.7.5 使用SimpleJdbcCall</h3><ul>
<li>示例</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">CREATE PROCEDURE read_actor (</span><br><span class="line">    IN in_id INTEGER,</span><br><span class="line">    OUT out_first_name VARCHAR(100),</span><br><span class="line">    OUT out_last_name VARCHAR(100),</span><br><span class="line">    OUT out_birth_date DATE)</span><br><span class="line">BEGIN</span><br><span class="line">    SELECT first_name, last_name, birth_date</span><br><span class="line">    INTO out_first_name, out_last_name, out_birth_date</span><br><span class="line">    FROM t_actor where id &#x3D; in_id;</span><br><span class="line">END;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JdbcActorDao</span> <span class="keyword">implements</span> <span class="title">ActorDao</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> JdbcTemplate jdbcTemplate;</span><br><span class="line">    <span class="keyword">private</span> SimpleJdbcCall procReadActor;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDataSource</span><span class="params">(DataSource dataSource)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.jdbcTemplate = <span class="keyword">new</span> JdbcTemplate(dataSource);</span><br><span class="line">        <span class="keyword">this</span>.procReadActor = <span class="keyword">new</span> SimpleJdbcCall(dataSource)</span><br><span class="line">                .withProcedureName(<span class="string">"read_actor"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Actor <span class="title">readActor</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">        SqlParameterSource in = <span class="keyword">new</span> MapSqlParameterSource()</span><br><span class="line">                .addValue(<span class="string">"in_id"</span>, id);</span><br><span class="line">        Map out = procReadActor.execute(in);</span><br><span class="line">        Actor actor = <span class="keyword">new</span> Actor();</span><br><span class="line">        actor.setId(id);</span><br><span class="line">        actor.setFirstName((String) out.get(<span class="string">"out_first_name"</span>));</span><br><span class="line">        actor.setLastName((String) out.get(<span class="string">"out_last_name"</span>));</span><br><span class="line">        actor.setBirthDate((Date) out.get(<span class="string">"out_birth_date"</span>));</span><br><span class="line">        <span class="keyword">return</span> actor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ... additional methods</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-7-6-其他存储过程操作"><a href="#3-7-6-其他存储过程操作" class="headerlink" title="3.7.6 其他存储过程操作"></a>3.7.6 其他存储过程操作</h3><p><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLnNwcmluZy5pby9zcHJpbmcvZG9jcy81LjAuOC5SRUxFQVNFL3NwcmluZy1mcmFtZXdvcmstcmVmZXJlbmNlL2RhdGEtYWNjZXNzLmh0bWwjamRiYy1hZHZhbmNlZC1qZGJj" title="https://docs.spring.io/spring/docs/5.0.8.RELEASE/spring-framework-reference/data-access.html#jdbc-advanced-jdbc">其他<i class="fa fa-external-link"></i></span></p>
<h2 id="3-8-使用对象操作数据库"><a href="#3-8-使用对象操作数据库" class="headerlink" title="3.8 使用对象操作数据库"></a>3.8 使用对象操作数据库</h2><ul>
<li>MappingSqlQuery</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ActorMappingQuery</span> <span class="keyword">extends</span> <span class="title">MappingSqlQuery</span>&lt;<span class="title">Actor</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ActorMappingQuery</span><span class="params">(DataSource ds)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(ds, <span class="string">"select id, first_name, last_name from t_actor where id = ?"</span>);</span><br><span class="line">        declareParameter(<span class="keyword">new</span> SqlParameter(<span class="string">"id"</span>, Types.INTEGER));</span><br><span class="line">        compile();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Actor <span class="title">mapRow</span><span class="params">(ResultSet rs, <span class="keyword">int</span> rowNumber)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">        Actor actor = <span class="keyword">new</span> Actor();</span><br><span class="line">        actor.setId(rs.getLong(<span class="string">"id"</span>));</span><br><span class="line">        actor.setFirstName(rs.getString(<span class="string">"first_name"</span>));</span><br><span class="line">        actor.setLastName(rs.getString(<span class="string">"last_name"</span>));</span><br><span class="line">        <span class="keyword">return</span> actor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li><h4 id="SqlUpdate"><a href="#SqlUpdate" class="headerlink" title="SqlUpdate"></a>SqlUpdate</h4></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.sql.Types;</span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jdbc.core.SqlParameter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jdbc.object.SqlUpdate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UpdateCreditRating</span> <span class="keyword">extends</span> <span class="title">SqlUpdate</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UpdateCreditRating</span><span class="params">(DataSource ds)</span> </span>&#123;</span><br><span class="line">        setDataSource(ds);</span><br><span class="line">        setSql(<span class="string">"update customer set credit_rating = ? where id = ?"</span>);</span><br><span class="line">        declareParameter(<span class="keyword">new</span> SqlParameter(<span class="string">"creditRating"</span>, Types.NUMERIC));</span><br><span class="line">        declareParameter(<span class="keyword">new</span> SqlParameter(<span class="string">"id"</span>, Types.NUMERIC));</span><br><span class="line">        compile();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id for the Customer to be updated</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> rating the new value for credit rating</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> number of rows updated</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">execute</span><span class="params">(<span class="keyword">int</span> id, <span class="keyword">int</span> rating)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> update(rating, id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><h4 id="StoredProcedure"><a href="#StoredProcedure" class="headerlink" title="StoredProcedure"></a>StoredProcedure</h4></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TitlesAndGenresStoredProcedure</span> <span class="keyword">extends</span> <span class="title">StoredProcedure</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SPROC_NAME = <span class="string">"AllTitlesAndGenres"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TitlesAndGenresStoredProcedure</span><span class="params">(DataSource dataSource)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(dataSource, SPROC_NAME);</span><br><span class="line">        declareParameter(<span class="keyword">new</span> SqlOutParameter(<span class="string">"titles"</span>, OracleTypes.CURSOR, <span class="keyword">new</span> TitleMapper()));</span><br><span class="line">        declareParameter(<span class="keyword">new</span> SqlOutParameter(<span class="string">"genres"</span>, OracleTypes.CURSOR, <span class="keyword">new</span> GenreMapper()));</span><br><span class="line">        compile();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">execute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// again, this sproc has no input parameters, so an empty Map is supplied</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.execute(<span class="keyword">new</span> HashMap&lt;String, Object&gt;());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="3-9-Handling-BLOB-and-CLOB-objects"><a href="#3-9-Handling-BLOB-and-CLOB-objects" class="headerlink" title="3.9 Handling BLOB and CLOB objects"></a>3.9 Handling BLOB and CLOB objects</h2><p>You can store images, other binary data, and large chunks of text in the database. These large objects are called BLOBs (Binary Large OBject) for binary data and CLOBs (Character Large OBject) for character data. In Spring you can handle these large objects by using the <code>JdbcTemplate</code> directly and also when using the higher abstractions provided by RDBMS Objects and the <code>SimpleJdbc</code> classes. All of these approaches use an implementation of the <code>LobHandler</code> interface for the actual management of the LOB (Large OBject) data. The <code>LobHandler</code> provides access to a <code>LobCreator</code> class, through the <code>getLobCreator</code> method, used for creating new LOB objects to be inserted.</p>
<p>The <code>LobCreator/LobHandler</code> provides the following support for LOB input and output:</p>
<ul>
<li>BLOB<ul>
<li><code>byte[]</code> — <code>getBlobAsBytes</code> and <code>setBlobAsBytes</code></li>
<li><code>InputStream</code> — <code>getBlobAsBinaryStream</code> and <code>setBlobAsBinaryStream</code></li>
</ul>
</li>
<li>CLOB<ul>
<li><code>String</code> — <code>getClobAsString</code> and <code>setClobAsString</code></li>
<li><code>InputStream</code> — <code>getClobAsAsciiStream</code> and <code>setClobAsAsciiStream</code></li>
<li><code>Reader</code> — <code>getClobAsCharacterStream</code> and <code>setClobAsCharacterStream</code></li>
</ul>
</li>
</ul>
<p>The next example shows how to create and insert a BLOB. Later you will see how to read it back from the database.</p>
<p>This example uses a <code>JdbcTemplate</code> and an implementation of the <code>AbstractLobCreatingPreparedStatementCallback</code>. It implements one method, <code>setValues</code>. This method provides a <code>LobCreator</code> that you use to set the values for the LOB columns in your SQL insert statement.</p>
<p>For this example we assume that there is a variable, <code>lobHandler</code>, that already is set to an instance of a <code>DefaultLobHandler</code>. You typically set this value through dependency injection.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> File blobIn = <span class="keyword">new</span> File(<span class="string">"spring2004.jpg"</span>);</span><br><span class="line"><span class="keyword">final</span> InputStream blobIs = <span class="keyword">new</span> FileInputStream(blobIn);</span><br><span class="line"><span class="keyword">final</span> File clobIn = <span class="keyword">new</span> File(<span class="string">"large.txt"</span>);</span><br><span class="line"><span class="keyword">final</span> InputStream clobIs = <span class="keyword">new</span> FileInputStream(clobIn);</span><br><span class="line"><span class="keyword">final</span> InputStreamReader clobReader = <span class="keyword">new</span> InputStreamReader(clobIs);</span><br><span class="line"></span><br><span class="line">jdbcTemplate.execute(</span><br><span class="line">    <span class="string">"INSERT INTO lob_table (id, a_clob, a_blob) VALUES (?, ?, ?)"</span>,</span><br><span class="line">    <span class="keyword">new</span> AbstractLobCreatingPreparedStatementCallback(lobHandler) &#123;  </span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setValues</span><span class="params">(PreparedStatement ps, LobCreator lobCreator)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">            ps.setLong(<span class="number">1</span>, <span class="number">1L</span>);</span><br><span class="line">            lobCreator.setClobAsCharacterStream(ps, <span class="number">2</span>, clobReader, (<span class="keyword">int</span>)clobIn.length());  </span><br><span class="line">            lobCreator.setBlobAsBinaryStream(ps, <span class="number">3</span>, blobIs, (<span class="keyword">int</span>)blobIn.length());  </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">blobIs.close();</span><br><span class="line">clobReader.close();</span><br></pre></td></tr></table></figure>

<p>Now it’s time to read the LOB data from the database. Again, you use a <code>JdbcTemplate</code> with the same instance variable <code>lobHandler</code> and a reference to a <code>DefaultLobHandler</code>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Map&lt;String, Object&gt;&gt; l = jdbcTemplate.query(<span class="string">"select id, a_clob, a_blob from lob_table"</span>,</span><br><span class="line">    <span class="keyword">new</span> RowMapper&lt;Map&lt;String, Object&gt;&gt;() &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">mapRow</span><span class="params">(ResultSet rs, <span class="keyword">int</span> i)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">            Map&lt;String, Object&gt; results = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line">            String clobText = lobHandler.getClobAsString(rs, <span class="string">"a_clob"</span>);  </span><br><span class="line">            results.put(<span class="string">"CLOB"</span>, clobText);</span><br><span class="line">            <span class="keyword">byte</span>[] blobBytes = lobHandler.getBlobAsBytes(rs, <span class="string">"a_blob"</span>);  </span><br><span class="line">            results.put(<span class="string">"BLOB"</span>, blobBytes);</span><br><span class="line">            <span class="keyword">return</span> results;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>



<h2 id="3-10-Handling-complex-types-for-stored-procedure-calls"><a href="#3-10-Handling-complex-types-for-stored-procedure-calls" class="headerlink" title="3.10 Handling complex types for stored procedure calls"></a>3.10 Handling complex types for stored procedure calls</h2><p>When you call stored procedures you can sometimes use complex types specific to the database. To accommodate these types, Spring provides a <code>SqlReturnType</code> for handling them when they are returned from the stored procedure call and <code>SqlTypeValue</code>when they are passed in as a parameter to the stored procedure.</p>
<p>Here is an example of returning the value of an Oracle <code>STRUCT</code> object of the user declared type <code>ITEM_TYPE</code>. The <code>SqlReturnType</code>interface has a single method named <code>getTypeValue</code> that must be implemented. This interface is used as part of the declaration of an <code>SqlOutParameter</code>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestItemStoredProcedure</span> <span class="keyword">extends</span> <span class="title">StoredProcedure</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TestItemStoredProcedure</span><span class="params">(DataSource dataSource)</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        declareParameter(<span class="keyword">new</span> SqlOutParameter(<span class="string">"item"</span>, OracleTypes.STRUCT, <span class="string">"ITEM_TYPE"</span>,</span><br><span class="line">            <span class="keyword">new</span> SqlReturnType() &#123;</span><br><span class="line">                <span class="function"><span class="keyword">public</span> Object <span class="title">getTypeValue</span><span class="params">(CallableStatement cs, <span class="keyword">int</span> colIndx, <span class="keyword">int</span> sqlType, String typeName)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">                    STRUCT struct = (STRUCT) cs.getObject(colIndx);</span><br><span class="line">                    Object[] attr = struct.getAttributes();</span><br><span class="line">                    TestItem item = <span class="keyword">new</span> TestItem();</span><br><span class="line">                    item.setId(((Number) attr[<span class="number">0</span>]).longValue());</span><br><span class="line">                    item.setDescription((String) attr[<span class="number">1</span>]);</span><br><span class="line">                    item.setExpirationDate((java.util.Date) attr[<span class="number">2</span>]);</span><br><span class="line">                    <span class="keyword">return</span> item;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;));</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>You use the <code>SqlTypeValue</code> to pass in the value of a Java object like <code>TestItem</code> into a stored procedure. The <code>SqlTypeValue</code>interface has a single method named <code>createTypeValue</code> that you must implement. The active connection is passed in, and you can use it to create database-specific objects such as <code>StructDescriptor</code>s, as shown in the following example, or <code>ArrayDescriptor</code>s.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> TestItem testItem = <span class="keyword">new</span> TestItem(<span class="number">123L</span>, <span class="string">"A test item"</span>,</span><br><span class="line">        <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-M-d"</span>).parse(<span class="string">"2010-12-31"</span>));</span><br><span class="line"></span><br><span class="line">SqlTypeValue value = <span class="keyword">new</span> AbstractSqlTypeValue() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Object <span class="title">createTypeValue</span><span class="params">(Connection conn, <span class="keyword">int</span> sqlType, String typeName)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">        StructDescriptor itemDescriptor = <span class="keyword">new</span> StructDescriptor(typeName, conn);</span><br><span class="line">        Struct item = <span class="keyword">new</span> STRUCT(itemDescriptor, conn,</span><br><span class="line">        <span class="keyword">new</span> Object[] &#123;</span><br><span class="line">            testItem.getId(),</span><br><span class="line">            testItem.getDescription(),</span><br><span class="line">            <span class="keyword">new</span> java.sql.Date(testItem.getExpirationDate().getTime())</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> item;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>This <code>SqlTypeValue</code> can now be added to the Map containing the input parameters for the execute call of the stored procedure.</p>
<p>Another use for the <code>SqlTypeValue</code> is passing in an array of values to an Oracle stored procedure. Oracle has its own internal <code>ARRAY</code> class that must be used in this case, and you can use the <code>SqlTypeValue</code> to create an instance of the Oracle <code>ARRAY</code> and populate it with values from the Java <code>ARRAY</code>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Long[] ids = <span class="keyword">new</span> Long[] &#123;<span class="number">1L</span>, <span class="number">2L</span>&#125;;</span><br><span class="line"></span><br><span class="line">SqlTypeValue value = <span class="keyword">new</span> AbstractSqlTypeValue() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Object <span class="title">createTypeValue</span><span class="params">(Connection conn, <span class="keyword">int</span> sqlType, String typeName)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">        ArrayDescriptor arrayDescriptor = <span class="keyword">new</span> ArrayDescriptor(typeName, conn);</span><br><span class="line">        ARRAY idArray = <span class="keyword">new</span> ARRAY(arrayDescriptor, conn, ids);</span><br><span class="line">        <span class="keyword">return</span> idArray;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>


    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>zxucooly
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://zxucooly.github.io/2018/12/05/spring%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3/9-%E6%95%B0%E6%8D%AE%E6%93%8D%E4%BD%9C-%E5%9F%BA%E7%A1%80/" title="9-数据操作-BASE">https://zxucooly.github.io/2018/12/05/spring官方文档/9-数据操作-基础/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</span> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/Spring%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3/" rel="tag"><i class="fa fa-tag"></i> Spring官方文档</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2018/12/05/spring%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3/2-Resources/" rel="prev" title="2-Resources">
      <i class="fa fa-chevron-left"></i> 2-Resources
    </a></div>
      <div class="post-nav-item">
    <a href="/2018/12/05/spring%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3/3-%E6%95%B0%E6%8D%AE%E9%AA%8C%E8%AF%81%E3%80%81%E6%95%B0%E6%8D%AE%E7%BB%91%E5%AE%9A%E3%80%81%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2/" rel="next" title="3-数据验证、数据绑定、类型转换">
      3-数据验证、数据绑定、类型转换 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1-事务管理"><span class="nav-number">1.</span> <span class="nav-text">1 事务管理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-理解事务管理的抽象类"><span class="nav-number">1.1.</span> <span class="nav-text">1.1 理解事务管理的抽象类</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-声明式事务管理"><span class="nav-number">1.2.</span> <span class="nav-text">1.2 声明式事务管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-1-理解声明式事务管理实现"><span class="nav-number">1.2.1.</span> <span class="nav-text">1.2.1 理解声明式事务管理实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-2-声明式事务管理实现实例"><span class="nav-number">1.2.2.</span> <span class="nav-text">1.2.2 声明式事务管理实现实例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-3-Rolling-back-a-declarative-transaction"><span class="nav-number">1.2.3.</span> <span class="nav-text">1.2.3 Rolling back a declarative transaction</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-4-Configuring-different-transactional-semantics-for-different-beans"><span class="nav-number">1.2.4.</span> <span class="nav-text">1.2.4 Configuring different transactional semantics for different beans</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-5-tx-advice-settings"><span class="nav-number">1.2.5.</span> <span class="nav-text">1.2.5 tx:advice&#x2F; settings</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-6-Using-Transactional-注解方式"><span class="nav-number">1.2.6.</span> <span class="nav-text">1.2.6 Using @Transactional-注解方式</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-6-1-Transactional-settings"><span class="nav-number">1.2.6.1.</span> <span class="nav-text">1.2.6.1 @Transactional settings</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-6-2-Multiple-Transaction-Managers-with-Transactional"><span class="nav-number">1.2.6.2.</span> <span class="nav-text">1.2.6.2 Multiple Transaction Managers with @Transactional</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-6-3-Custom-shortcut-annotations"><span class="nav-number">1.2.6.3.</span> <span class="nav-text">1.2.6.3 Custom shortcut annotations</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-7-事务传播"><span class="nav-number">1.2.7.</span> <span class="nav-text">1.2.7 事务传播</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-7-1-Required"><span class="nav-number">1.2.7.1.</span> <span class="nav-text">1.2.7.1 Required</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-7-2-RequiresNew"><span class="nav-number">1.2.7.2.</span> <span class="nav-text">1.2.7.2 RequiresNew</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-7-2-PROPAGATION-REQUIRES-NEW"><span class="nav-number">1.2.7.3.</span> <span class="nav-text">1.2.7.2 PROPAGATION_REQUIRES_NEW</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-7-4-Nested"><span class="nav-number">1.2.7.4.</span> <span class="nav-text">1.2.7.4 Nested</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-3-编程式事务"><span class="nav-number">1.3.</span> <span class="nav-text">1.3 编程式事务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-4-编程式VS声明式"><span class="nav-number">1.4.</span> <span class="nav-text">1.4 编程式VS声明式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-5-Transaction-bound-event"><span class="nav-number">1.5.</span> <span class="nav-text">1.5 Transaction bound event</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-Dao-Support"><span class="nav-number">2.</span> <span class="nav-text">2 Dao Support</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-一致的层级异常结构"><span class="nav-number">2.1.</span> <span class="nav-text">2.1 一致的层级异常结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-注解配置Dao"><span class="nav-number">2.2.</span> <span class="nav-text">2.2 注解配置Dao</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-Data-access-with-JDBC"><span class="nav-number">3.</span> <span class="nav-text">3 Data access with JDBC</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-JDBC-Support"><span class="nav-number">3.1.</span> <span class="nav-text">3.1 JDBC Support</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-访问JDBC数据库的方式"><span class="nav-number">3.2.</span> <span class="nav-text">3.2 访问JDBC数据库的方式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-1-JdbcTemplate"><span class="nav-number">3.2.1.</span> <span class="nav-text">3.2.1 JdbcTemplate</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-2-NamedParameterJdbcTemplate"><span class="nav-number">3.2.2.</span> <span class="nav-text">3.2.2 NamedParameterJdbcTemplate</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-3-SQLExceptionTranslator"><span class="nav-number">3.3.</span> <span class="nav-text">3.3 SQLExceptionTranslator</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-4-Retrieving-auto-generated-keys"><span class="nav-number">3.4.</span> <span class="nav-text">3.4 Retrieving auto-generated keys</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-5-数据源连接管理"><span class="nav-number">3.5.</span> <span class="nav-text">3.5 数据源连接管理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-6-JDBC批量操作"><span class="nav-number">3.6.</span> <span class="nav-text">3.6 JDBC批量操作</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#with-a-List-of-objects"><span class="nav-number">3.6.0.1.</span> <span class="nav-text">with a List of objects</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#with-multiple-batches"><span class="nav-number">3.6.0.2.</span> <span class="nav-text">with multiple batches</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-7-Simplifying-JDBC-operations-with-the-SimpleJdbc-classes"><span class="nav-number">3.7.</span> <span class="nav-text">3.7 Simplifying JDBC operations with the SimpleJdbc classes</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-7-1-使用SimpleJdbcInsert插入数据"><span class="nav-number">3.7.1.</span> <span class="nav-text">3.7.1 使用SimpleJdbcInsert插入数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-7-2-使用SimpleJdbcInsert获取自增长值"><span class="nav-number">3.7.2.</span> <span class="nav-text">3.7.2 使用SimpleJdbcInsert获取自增长值</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-7-3-Specifying-columns-for-a-SimpleJdbcInsert"><span class="nav-number">3.7.3.</span> <span class="nav-text">3.7.3 Specifying columns for a SimpleJdbcInsert</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-7-4-Using-SqlParameterSource-to-provide-parameter-values"><span class="nav-number">3.7.4.</span> <span class="nav-text">3.7.4 Using SqlParameterSource to provide parameter values</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-7-5-使用SimpleJdbcCall"><span class="nav-number">3.7.5.</span> <span class="nav-text">3.7.5 使用SimpleJdbcCall</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-7-6-其他存储过程操作"><span class="nav-number">3.7.6.</span> <span class="nav-text">3.7.6 其他存储过程操作</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-8-使用对象操作数据库"><span class="nav-number">3.8.</span> <span class="nav-text">3.8 使用对象操作数据库</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#SqlUpdate"><span class="nav-number">3.8.0.1.</span> <span class="nav-text">SqlUpdate</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#StoredProcedure"><span class="nav-number">3.8.0.2.</span> <span class="nav-text">StoredProcedure</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-9-Handling-BLOB-and-CLOB-objects"><span class="nav-number">3.9.</span> <span class="nav-text">3.9 Handling BLOB and CLOB objects</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-10-Handling-complex-types-for-stored-procedure-calls"><span class="nav-number">3.10.</span> <span class="nav-text">3.10 Handling complex types for stored procedure calls</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="zxucooly"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">zxucooly</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">48</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <span class="exturl" data-url="bWFpbHRvOnp4dWNvb2x5QGdtYWlsLmNvbQ==" title="E-Mail → mailto:zxucooly@gmail.com"><i class="fa fa-fw fa-envelope"></i>E-Mail</span>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 2017 – 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zxu's blog</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
